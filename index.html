<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å»Šæ ¡å†…ç«èµ›ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="icon" type="image/png" sizes="32x32" href="https://em-content.zobj.net/source/apple/419/trophy_1f3c6.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://em-content.zobj.net/source/apple/419/trophy_1f3c6.png">
    <link rel="apple-touch-icon" href="https://em-content.zobj.net/source/apple/419/trophy_1f3c6.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95); }
        body { font-family: "Comic Sans MS", "Microsoft YaHei", sans-serif; }
    </style>
</head>
<body class="bg-yellow-50 text-gray-800">

    <div id="app" class="min-h-screen flex flex-col">
        
        <!-- Navbar -->
        <nav class="bg-orange-500 text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div @click="goHome" class="flex items-center space-x-2 cursor-pointer group">
                    <i class="fas fa-shapes text-yellow-200 text-2xl group-hover:scale-110 transition"></i>
                    <div>
                        <h1 class="text-lg font-bold leading-tight">æ ¡å†…ç«èµ›ç³»ç»Ÿ</h1>
                        <p class="text-xs text-orange-100 opacity-90">äº‘ç«¯å®æ—¶ç‰ˆ</p>
                    </div>
                </div>
                <div class="flex space-x-2 text-sm font-bold">
                    <button @click="goHome" :class="{'bg-white text-orange-600 shadow-md': currentTab === 'results'}" class="px-3 py-2 rounded-lg transition duration-200 flex items-center hover:bg-orange-400">
                        <i class="fas fa-home mr-1"></i> å¤§å…
                    </button>
                    <button @click="currentTab = 'register'" :class="{'bg-white text-orange-600 shadow-md': currentTab === 'register'}" class="px-3 py-2 rounded-lg transition duration-200 flex items-center hover:bg-orange-400">
                        <i class="fas fa-chalkboard-teacher mr-1"></i> æŠ¥å
                    </button>
                    <button @click="enterAdmin" :class="{'bg-gray-800 text-yellow-400 shadow-md': currentTab === 'admin' || isAdmin}" class="px-3 py-2 rounded-lg transition duration-200 flex items-center border border-orange-400 hover:bg-orange-600">
                        <i class="fas" :class="isAdmin ? 'fa-user-shield' : 'fa-cogs'"></i> <span class="ml-1">{{ isAdmin ? 'ç®¡ç†å‘˜' : 'ç®¡ç†' }}</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-6 max-w-5xl">

            <!-- TAB 1: æ¯”èµ›å¤§å… -->
            <transition name="fade" mode="out-in">
                <!-- ç§»é™¤ !isInitializing æ¡ä»¶ï¼Œè®©é¡µé¢ç«‹å³æ¸²æŸ“éª¨æ¶å± -->
                <div v-if="currentTab === 'results'" key="results" class="space-y-6">
                    <!-- å·¥å…·æ  -->
                    <div class="flex flex-row gap-3 items-center justify-between">
                        <h2 v-if="!selectedCategory" class="text-xl font-bold text-gray-700 hidden sm:block">
                            <i class="fas fa-bullhorn text-orange-500 mr-2"></i>æ¯”èµ›å¤§å…
                        </h2>
                        <div class="flex-grow flex gap-2 justify-end items-center">
                             <div class="flex items-center text-xs text-orange-400/80 mr-1 bg-white px-2 py-1 rounded-full border border-orange-100 shadow-sm hidden sm:flex">
                                <span class="relative flex h-2 w-2 mr-2">
                                  <span :class="isInitializing ? 'bg-gray-300' : 'bg-green-400 animate-ping'" class="absolute inline-flex h-full w-full rounded-full opacity-75"></span>
                                  <span :class="isInitializing ? 'bg-gray-400' : 'bg-green-500'" class="relative inline-flex rounded-full h-2 w-2"></span>
                                </span>
                                {{ isInitializing ? 'è¿æ¥ä¸­...' : 'å®æ—¶åŒæ­¥' }}
                            </div>

                             <div class="relative w-full max-w-xs sm:max-w-md">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input v-model="searchQuery" type="text" placeholder="æœå§“åã€ç­çº§æˆ–é¡¹ç›®..." 
                                    class="w-full border border-orange-200 rounded-full pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300 transition bg-white shadow-sm">
                            </div>
                            <button @click="fetchAllData(false)" class="bg-white text-orange-600 px-3 py-2 rounded-full shadow-sm border border-orange-100 hover:bg-orange-50 transition font-bold text-sm whitespace-nowrap" title="ç«‹å³åˆ·æ–°">
                                <i class="fas fa-sync-alt" :class="{'fa-spin': isRefreshing}"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ç®¡ç†å‘˜æç¤ºæ¡ -->
                    <div v-if="isAdmin" class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded-r shadow-sm flex justify-between items-center text-sm">
                        <span class="text-blue-700"><i class="fas fa-info-circle mr-1"></i> æ‚¨å¤„äºç®¡ç†å‘˜æ¨¡å¼ï¼Œç‚¹å‡»åå•æ—çš„ <i class="fas fa-pencil-alt text-gray-400"></i> å¯å½•å…¥æˆç»©ã€‚</span>
                        <button @click="isAdmin=false; currentTab='results'" class="text-blue-400 hover:text-blue-600 underline text-xs">é€€å‡ºç®¡ç†</button>
                    </div>

                    <!-- è§†å›¾ A: æ¯”èµ›é¡¹ç›®åˆ—è¡¨ (å«éª¨æ¶å±) -->
                    <div v-if="!selectedCategory">
                        
                        <!-- éª¨æ¶å± (Loading Skeleton) -->
                        <div v-if="isInitializing" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 animate-pulse">
                            <div v-for="n in 6" :key="n" class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 flex flex-col items-center text-center h-48">
                                <div class="w-16 h-16 rounded-full bg-gray-200 mb-4"></div>
                                <div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div>
                                <div class="mt-auto w-full pt-2">
                                    <div class="h-4 bg-gray-200 rounded w-1/3 mx-auto"></div>
                                </div>
                            </div>
                        </div>

                        <!-- çœŸå®æ•°æ® -->
                        <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div v-for="group in groupedResults" :key="group.categoryName" 
                                 @click="selectedCategory = group.categoryName"
                                 class="bg-white rounded-2xl shadow-md border-2 border-transparent hover:border-orange-400 hover:shadow-xl transition cursor-pointer p-6 flex flex-col items-center text-center group h-full transform hover:-translate-y-1">
                                <div class="w-16 h-16 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-3xl mb-4 shadow-inner">
                                    <i :class="getCategoryIcon(group.categoryName)"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 mb-2">{{ group.categoryName }}</h3>
                                <div class="mt-auto w-full pt-2">
                                    <span class="text-xs font-bold text-white bg-green-500 px-2 py-0.5 rounded-full shadow-sm">è¿›è¡Œä¸­</span>
                                    <div class="text-gray-500 text-sm mt-2">å·²æŠ¥: <span class="text-xl font-bold text-orange-600">{{ group.totalCount }}</span> äºº</div>
                                </div>
                            </div>

                            <div v-if="groupedResults.length === 0" class="col-span-full text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-300">
                                <p class="text-gray-500 mb-4">æš‚æ— æ¯”èµ›é¡¹ç›®</p>
                                <button @click="enterAdmin" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm">å‰å¾€åå°æ·»åŠ </button>
                            </div>
                        </div>
                    </div>

                    <!-- è§†å›¾ B: é¡¹ç›®è¯¦æƒ…é¡µ (åˆ†å¹´çº§å±•ç¤º) -->
                    <div v-else class="space-y-6">
                        <div class="flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-orange-100 sticky top-16 z-30">
                            <button @click="selectedCategory = null" class="text-gray-600 hover:text-orange-600 font-bold flex items-center bg-gray-100 px-3 py-1.5 rounded-lg text-sm">
                                <i class="fas fa-arrow-left mr-2"></i> è¿”å›
                            </button>
                            <h2 class="text-lg font-bold text-gray-800">{{ selectedCategory }}</h2>
                            <div class="text-sm bg-orange-100 text-orange-700 px-3 py-1 rounded-full font-bold">{{ getSelectedGroupCount() }} äºº</div>
                        </div>

                        <!-- è¯¦æƒ…é¡µæ•°æ®ç©º -->
                        <div v-if="getSelectedGroupCount() === 0" class="text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-200">
                            <p class="text-gray-500 mb-4">æš‚æ— æŠ¥åè®°å½•</p>
                            <button @click="goToRegister(selectedCategory)" class="bg-orange-500 text-white px-6 py-2 rounded-full font-bold shadow hover:bg-orange-600">å»æŠ¥å</button>
                        </div>

                        <!-- è¯¦æƒ…é¡µæ•°æ®åˆ—è¡¨ -->
                        <div v-else>
                            <!-- æ–°å¢æŠ¥åæŒ‰é’® (ç½®é¡¶) -->
                            <div class="mb-6 flex justify-end">
                                <button @click="goToRegister(selectedCategory)" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-orange-600 text-sm flex items-center">
                                    <i class="fas fa-plus-circle mr-2"></i> æ–°å¢æŠ¥å
                                </button>
                            </div>

                            <!-- æŒ‰å¹´çº§åˆ†ç»„å¾ªç¯ -->
                            <div v-for="(gradeGroup, gIndex) in getSelectedGroupedByGrade()" :key="gIndex" class="mb-8">
                                <!-- å¹´çº§æ ‡é¢˜ -->
                                <div class="flex items-center mb-4">
                                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold text-sm shadow-sm border border-blue-200">
                                        {{ gradeGroup.gradeLabel }}
                                    </span>
                                    <div class="h-px bg-blue-100 flex-grow ml-4"></div>
                                </div>

                                <!-- è¯¥å¹´çº§ä¸‹çš„ç­çº§ Grid -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div v-for="cls in gradeGroup.classes" :key="cls.className" class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm relative overflow-hidden">
                                        <div class="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                                            <span class="font-bold text-blue-600 text-lg">{{ cls.className }}</span>
                                            <span class="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-bold">{{ cls.students.length }}äºº</span>
                                        </div>
                                        <ul class="space-y-2">
                                            <li v-for="stu in cls.students" :key="stu.rowIndex" class="flex justify-between items-center text-sm p-2 rounded hover:bg-gray-50 transition group">
                                                
                                                <!-- å·¦ä¾§ï¼šåå­— -->
                                                <span class="font-medium text-gray-700 flex items-center">
                                                    {{ stu.studentName }}
                                                </span>

                                                <!-- å³ä¾§ï¼šåˆ†æ•°/æ’å/ç¼–è¾‘ -->
                                                <div class="flex items-center gap-2">
                                                    <span v-if="stu.rank" :class="getRankClass(stu.rank)" class="text-xs px-2 py-0.5 rounded font-bold scale-90">
                                                        {{ stu.rank }}
                                                    </span>
                                                    <span v-else-if="stu.score" class="text-gray-500 font-mono text-xs bg-gray-100 px-1 rounded">
                                                        {{ stu.score }}åˆ†
                                                    </span>
                                                    
                                                    <button v-if="isAdmin" @click.stop="openScoreModal(stu, cls.className)" class="text-gray-300 hover:text-blue-500 p-1 transition opacity-0 group-hover:opacity-100" title="å½•å…¥æˆç»©">
                                                        <i class="fas fa-pencil-alt"></i>
                                                    </button>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- TAB 2: æŠ¥åé¡µé¢ -->
            <transition name="fade" mode="out-in">
                <!-- ç§»é™¤ !isInitializing, è®©é¡µé¢åœ¨åˆå§‹åŠ è½½æ—¶ä¹Ÿèƒ½æ˜¾ç¤ºç»“æ„ (æˆ–æ˜¾ç¤ºéª¨æ¶å±) -->
                <div v-if="currentTab === 'register'" key="register" class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-6 border-t-4 border-orange-400">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-start">
                            <div class="bg-orange-100 p-3 rounded-full mr-4"><i class="fas fa-user-edit text-orange-500 text-xl"></i></div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">æŠ¥åå½•å…¥</h2>
                                <p class="text-gray-500 text-sm">æ‰€æœ‰é€‰é¡¹å‡æ¥è‡ª Google Sheets å®æ—¶æ•°æ®</p>
                            </div>
                        </div>
                        <button @click="goHome" class="text-gray-400 hover:text-gray-600 text-sm underline">å–æ¶ˆ</button>
                    </div>

                    <!-- æŠ¥åé¡µéª¨æ¶å± -->
                    <div v-if="isInitializing" class="space-y-6 animate-pulse">
                        <div class="h-20 bg-gray-200 rounded-xl"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="h-32 bg-gray-200 rounded-xl"></div>
                            <div class="h-32 bg-gray-200 rounded-xl"></div>
                        </div>
                    </div>

                    <form v-else @submit.prevent="submitForm" class="space-y-6">
                        <!-- é¡¹ç›® -->
                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                            <label class="block text-sm font-bold text-gray-700 mb-2">å‚èµ›é¡¹ç›®</label>
                            <select v-model="form.category" required class="w-full rounded-lg border-2 border-yellow-300 p-3 outline-none bg-white font-medium text-gray-800">
                                <option value="" disabled>è¯·é€‰æ‹©...</option>
                                <option v-for="item in competitionItems" :key="item" :value="item">{{ item }}</option>
                            </select>
                            <p v-if="competitionItems.length === 0" class="text-xs text-red-500 mt-2">* æš‚æ— é¡¹ç›®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜åœ¨åå°æ·»åŠ ã€‚</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <!-- ç­çº§ -->
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 h-fit">
                                <label class="block text-sm font-bold text-blue-800 mb-2">æ‰€å±ç­çº§</label>
                                <select v-model="form.stuClass" required class="w-full rounded-lg border-2 border-blue-200 p-3 outline-none bg-white font-mono text-lg">
                                    <option value="" disabled>é€‰æ‹©ç­çº§</option>
                                    <option v-for="cls in availableClasses" :key="cls" :value="cls">{{ cls }}</option>
                                </select>
                                <div class="mt-2 text-xs text-gray-500">
                                    <label class="flex items-center"><input type="checkbox" v-model="keepClassInfo" class="mr-1"> è¿ç»­æŠ¥åä¿ç•™ç­çº§</label>
                                </div>
                                <div v-if="availableClasses.length === 0" class="text-xs text-red-400 mt-2">
                                    * æœªåŠ è½½åˆ°ç­çº§ï¼Œè¯·æ£€æŸ¥ "Students" è¡¨æ ¼ã€‚
                                </div>
                            </div>

                            <!-- å­¦ç”Ÿ -->
                            <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                                <label class="block text-sm font-bold text-green-800 mb-2">é€‰æ‹©å­¦ç”Ÿ (æœ€å¤š3äºº)</label>
                                <div v-if="!form.stuClass" class="text-gray-400 text-sm py-8 text-center border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">â† å…ˆé€‰ç­çº§</div>
                                <div v-else class="space-y-3">
                                    <div v-for="(sel, idx) in form.selectedStudents" :key="idx" class="relative">
                                        <span class="absolute left-3 top-3 text-xs font-bold text-gray-400">{{ idx + 1 }}.</span>
                                        <select v-model="form.selectedStudents[idx]" class="w-full rounded-lg border border-green-200 pl-8 p-2 bg-white outline-none focus:border-green-500">
                                            <option value="">(ç©º)</option>
                                            <option v-for="stuName in availableStudents" :key="stuName" :value="stuName">{{ stuName }}</option>
                                        </select>
                                    </div>
                                    <div class="text-right">
                                        <button type="button" @click="form.selectedStudents = ['', '', '']" class="text-xs text-gray-400 hover:text-red-500 underline">æ¸…ç©º</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" :disabled="isSubmitting" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform active:scale-95 transition disabled:opacity-60 disabled:cursor-not-allowed">
                            <span v-if="isSubmitting" class="loader inline-block mr-2 w-4 h-4 border-2 border-white border-t-transparent"></span>
                            {{ isSubmitting ? 'æäº¤ä¸­...' : 'ç¡®è®¤æŠ¥å' }}
                        </button>
                    </form>
                </div>
            </transition>

            <!-- TAB 3: ç®¡ç†åå° -->
            <transition name="fade" mode="out-in">
                <div v-if="currentTab === 'admin'" key="admin" class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                    <div class="bg-gray-800 text-white p-6 flex justify-between items-center">
                        <h2 class="text-xl font-bold"><i class="fas fa-cogs text-yellow-400 mr-2"></i>é¡¹ç›®ç®¡ç†åå°</h2>
                        <button @click="goHome"><i class="fas fa-times hover:text-gray-300"></i></button>
                    </div>
                    <div class="p-6">
                        <div class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <label class="block text-sm font-bold text-gray-700 mb-2">æ·»åŠ æ–°é¡¹ç›® (åŒæ­¥è‡³äº‘ç«¯)</label>
                            <div class="flex gap-2">
                                <input v-model="adminNewItem" :disabled="isSubmitting" @keyup.enter="adminAddItem" type="text" placeholder="ä¾‹å¦‚ï¼šæœºå™¨äººå¤§èµ›" class="flex-grow border border-gray-300 rounded-lg px-4 py-2 outline-none focus:border-green-500">
                                <button @click="adminAddItem" :disabled="isSubmitting" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50">
                                    <i v-if="isSubmitting" class="fas fa-spinner fa-spin"></i> æ·»åŠ 
                                </button>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-700 mb-3">äº‘ç«¯é¡¹ç›®åˆ—è¡¨ ({{ competitionItems.length }})</h3>
                            
                            <!-- åå°åŠ è½½éª¨æ¶å± -->
                            <div v-if="isInitializing" class="space-y-2 animate-pulse">
                                <div v-for="n in 3" :key="n" class="h-12 bg-gray-200 rounded-lg"></div>
                            </div>

                            <ul v-else class="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                                <li v-for="(item, index) in competitionItems" :key="index" class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                                    <div class="flex items-center">
                                        <i :class="getCategoryIcon(item)" class="text-orange-400 mr-3 w-6 text-center"></i>
                                        <span>{{ item }}</span>
                                    </div>
                                    <button @click="adminDeleteItem(item)" :disabled="isSubmitting" class="text-gray-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </transition>

        </main>

        <!-- é€šç”¨ Modal (Alert/Confirm/Prompt) -->
        <transition name="modal">
            <div v-if="modalState.visible" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="handleModalCancel">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden">
                    <div class="bg-orange-500 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="font-bold text-lg"><i :class="modalState.icon"></i> {{ modalState.title }}</h3>
                        <button @click="handleModalCancel"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4 whitespace-pre-line">{{ modalState.message }}</p>
                        <input v-if="['prompt', 'password'].includes(modalState.type)" :type="modalState.type === 'password' ? 'password' : 'text'" v-model="modalState.inputValue" @keyup.enter="handleModalConfirm" ref="modalInput" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 outline-none focus:border-orange-500" :placeholder="modalState.placeholder">
                    </div>
                    <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                        <button v-if="modalState.type !== 'alert'" @click="handleModalCancel" class="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded-lg text-sm font-bold">å–æ¶ˆ</button>
                        <button @click="handleModalConfirm" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-sm font-bold">ç¡®å®š</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- æˆç»©å½•å…¥ä¸“ç”¨ Modal -->
        <transition name="modal">
            <div v-if="scoreModal.visible" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/50 backdrop-blur-sm">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden transform transition-all">
                    <div class="bg-blue-600 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="font-bold text-lg"><i class="fas fa-medal mr-2"></i>æˆç»©å½•å…¥</h3>
                        <button @click="scoreModal.visible = false"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="bg-blue-50 p-3 rounded text-sm text-blue-800">
                            æ­£åœ¨ä¸º <strong>{{ scoreModal.className }}</strong> çš„ <strong>{{ scoreModal.studentName }}</strong> å½•å…¥æˆç»©ã€‚
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">åˆ†æ•° (å¯é€‰)</label>
                            <input type="text" v-model="scoreModal.score" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚: 95">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">å¥–é¡¹/åæ¬¡ (å¯é€‰)</label>
                            <select v-model="scoreModal.rank" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="">æ— </option>
                                <option value="å† å†›">ğŸ† å† å†›</option>
                                <option value="äºšå†›">ğŸ¥ˆ äºšå†›</option>
                                <option value="å­£å†›">ğŸ¥‰ å­£å†›</option>
                                <option value="ç‰¹ä¼˜å¥–">ğŸ… ç‰¹ä¼˜å¥–</option>
                                <option value="ä¼˜ç§€å¥–">ğŸ–ï¸ ä¼˜ç§€å¥–</option>
                                <option value="å®‰æ…°å¥–">ğŸ—ï¸ å®‰æ…°å¥–</option>
                            </select>
                        </div>
                    </div>
                    <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                        <button @click="scoreModal.visible = false" class="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded-lg text-sm font-bold">å–æ¶ˆ</button>
                        <button @click="submitScore" :disabled="isSubmitting" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold disabled:opacity-50 flex items-center">
                            <i v-if="isSubmitting" class="fas fa-spinner fa-spin mr-2"></i> ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;

        // âš ï¸ é‡è¦ï¼šæ›¿æ¢ä¸ºä½ æœ€æ–°çš„ Web App URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyTFPIi2XSLH7F6bkce1XhDC_6fb24EyqHNTf7nE_h0J0CB_fVG4TlIwms5rwJdpUxG/exec"; 

        createApp({
            setup() {
                // State
                const currentTab = ref('results');
                const selectedCategory = ref(null);
                const isInitializing = ref(true);
                const isRefreshing = ref(false);
                const isSubmitting = ref(false);
                const isAdmin = ref(false); // ç®¡ç†å‘˜çŠ¶æ€
                
                const initStatus = ref({ items: false, students: false, results: false });
                
                // Data from Cloud
                const competitionItems = ref([]);
                const studentDB = ref({});
                const classList = ref([]);
                const dbResults = ref([]);
                
                // Forms
                const form = ref({ stuClass: '', category: '', selectedStudents: ['', '', ''] });
                const keepClassInfo = ref(true);
                const adminNewItem = ref('');
                const searchQuery = ref('');

                // Modals
                const modalState = ref({ visible: false, type: 'alert', title: '', message: '', inputValue: '', placeholder: '', icon: '', resolve: null });
                const modalInput = ref(null);
                
                // Score Modal
                const scoreModal = ref({ visible: false, studentName: '', className: '', score: '', rank: '', category: '' });
                
                // Timer
                let autoRefreshTimer = null;

                // --- API äº¤äº’æ ¸å¿ƒ ---
                const fetchAPI = async (action, payload = null) => {
                    if (GOOGLE_SCRIPT_URL.includes("åœ¨æ­¤å¤„ç²˜è´´")) throw new Error("API URL æœªé…ç½®");
                    
                    try {
                        if (payload) { // POST
                            const response = await fetch(GOOGLE_SCRIPT_URL, {
                                method: 'POST',
                                mode: 'no-cors', 
                                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                                body: JSON.stringify({ action, ...payload })
                            });
                            return response; 
                        } else { // GET
                            const timestamp = new Date().getTime();
                            const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=${action}&_t=${timestamp}`);
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return await response.json();
                        }
                    } catch (error) {
                        console.error("API Error:", error);
                        if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                            throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼šå¯èƒ½æ˜¯ URL é”™è¯¯æˆ–è·¨åŸŸé—®é¢˜");
                        }
                        throw error;
                    }
                };

                // --- æ™ºèƒ½æ•°æ®æ¸…æ´— (New) ---
                const normalizeData = (rawData) => {
                    if (!Array.isArray(rawData)) return [];
                    return rawData.map(item => {
                        const newItem = {};
                        Object.keys(item).forEach(key => {
                            // ç§»é™¤ç©ºæ ¼å¹¶è½¬å°å†™
                            const k = key.toLowerCase().replace(/\s+/g, '');
                            
                            if (['studentname', 'name', 'å§“å', 'å­¦ç”Ÿå§“å', 'å­¦ç”Ÿ'].includes(k)) newItem.studentName = item[key];
                            else if (['studentclass', 'class', 'ç­çº§'].includes(k)) newItem.studentClass = item[key];
                            else if (['category', 'competition', 'é¡¹ç›®', 'æ¯”èµ›é¡¹ç›®', 'æ¯”èµ›'].includes(k)) newItem.category = item[key];
                            else if (['score', 'åˆ†æ•°', 'æˆç»©'].includes(k)) newItem.score = item[key];
                            else if (['rank', 'ranking', 'åæ¬¡', 'å¥–é¡¹', 'æ’å'].includes(k)) newItem.rank = item[key];
                            else newItem[key] = item[key]; // ä¿ç•™å…¶ä»–å­—æ®µ
                        });
                        
                        // å…œåº•ç­–ç•¥
                        if(!newItem.studentName) newItem.studentName = newItem.Name || '';
                        if(!newItem.studentClass) newItem.studentClass = newItem.Class || '';
                        if(!newItem.category) newItem.category = newItem.Category || '';
                        
                        return newItem;
                    });
                };

                const fetchAllData = async (isBackground = false) => {
                    if (!isBackground) isRefreshing.value = true;
                    try {
                        const items = await fetchAPI('getCompetitions');
                        competitionItems.value = items;
                        initStatus.value.items = true;

                        const rawStudents = await fetchAPI('getStudents');
                        // æ¸…æ´—å­¦ç”Ÿåå•æ•°æ®
                        const cleanedStudents = normalizeData(rawStudents);
                        
                        const db = {};
                        cleanedStudents.forEach(s => {
                            if(s.studentClass && s.studentName) {
                                if (!db[s.studentClass]) db[s.studentClass] = [];
                                db[s.studentClass].push(s.studentName);
                            }
                        });
                        studentDB.value = db;
                        classList.value = Object.keys(db).sort();
                        initStatus.value.students = true;

                        const rawResults = await fetchAPI('getResults');
                        // æ ¸å¿ƒä¿®å¤ï¼šæ¸…æ´—æŠ¥åæ•°æ®
                        const cleanedResults = normalizeData(rawResults);
                        
                        dbResults.value = cleanedResults.map((item, i) => ({ ...item, rowIndex: i }));
                        initStatus.value.results = true;

                    } catch (e) {
                        console.error(e);
                        if (!isBackground && e.message !== "API URL æœªé…ç½®") {
                           await showDialog({ type: 'alert', title: 'è¿æ¥å¤±è´¥', message: 'æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– URL é…ç½®ã€‚\n' + e.message, icon: 'fas fa-unlink' });
                        }
                    } finally {
                        isInitializing.value = false;
                        if (!isBackground) isRefreshing.value = false;
                    }
                };

                onMounted(() => {
                    if(!GOOGLE_SCRIPT_URL.includes("åœ¨æ­¤å¤„ç²˜è´´")) {
                        fetchAllData();
                        autoRefreshTimer = setInterval(() => { fetchAllData(true); }, 10000);
                    } else {
                        isInitializing.value = false; 
                        showDialog({title:'é…ç½®æç¤º', message:'è¯·ç¼–è¾‘ä»£ç å¡«å…¥ Web App URL', icon: 'fas fa-cog'});
                    }
                });
                
                onUnmounted(() => { if (autoRefreshTimer) clearInterval(autoRefreshTimer); });

                // --- ä¸šåŠ¡é€»è¾‘ ---
                const adminAddItem = async () => {
                    const name = adminNewItem.value.trim();
                    if (!name) return;
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('addCompetition', { name });
                        adminNewItem.value = '';
                        await fetchAllData(); 
                        await showDialog({ type: 'alert', title: 'æˆåŠŸ', message: 'é¡¹ç›®å·²æ·»åŠ åˆ°äº‘ç«¯ã€‚', icon: 'fas fa-check' });
                    } catch(e) { console.error(e); }
                    isSubmitting.value = false;
                };

                const adminDeleteItem = async (name) => {
                    if (!(await showDialog({ type: 'confirm', title: 'åˆ é™¤ç¡®è®¤', message: `ç¡®å®šè¦ä»äº‘ç«¯æ°¸ä¹…åˆ é™¤â€œ${name}â€å—ï¼Ÿ`, icon: 'fas fa-trash' }))) return;
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('deleteCompetition', { name });
                        await fetchAllData();
                    } catch(e) { console.error(e); }
                    isSubmitting.value = false;
                };

                const submitForm = async () => {
                    const validStudents = form.value.selectedStudents.filter(s => s);
                    if (validStudents.length === 0) return showDialog({ title: 'æç¤º', message: 'è¯·è‡³å°‘é€‰æ‹©ä¸€åå­¦ç”Ÿ' });
                    
                    isSubmitting.value = true;
                    let successCount = 0;
                    for (const stuName of validStudents) {
                        try {
                            await fetchAPI('register', { 
                                name: stuName, 
                                stuClass: form.value.stuClass, 
                                category: form.value.category 
                            });
                            successCount++;
                        } catch(e) { console.error(e); }
                    }
                    await showDialog({ type: 'alert', title: 'æŠ¥åå®Œæˆ', message: `æˆåŠŸæŠ¥å ${successCount} äºº`, icon: 'fas fa-check-circle' });
                    if (keepClassInfo.value) form.value.selectedStudents = ['', '', ''];
                    else form.value = { stuClass: '', category: '', selectedStudents: ['', '', ''] };
                    isSubmitting.value = false;
                    fetchAllData(); 
                };

                // â˜…â˜…â˜… æˆç»©ç®¡ç†é€»è¾‘ â˜…â˜…â˜…
                const openScoreModal = (stu, className) => {
                    scoreModal.value = {
                        visible: true,
                        studentName: stu.studentName,
                        className: className,
                        score: stu.score || '',
                        rank: stu.rank || '',
                        category: selectedCategory.value // å½“å‰é€‰ä¸­çš„æ¯”èµ›é¡¹ç›®
                    };
                };

                const submitScore = async () => {
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('updateScore', {
                            name: scoreModal.value.studentName,
                            stuClass: scoreModal.value.className,
                            category: scoreModal.value.category,
                            score: scoreModal.value.score,
                            rank: scoreModal.value.rank
                        });
                        
                        scoreModal.value.visible = false;
                        // ä¹è§‚æ›´æ–°UI (ä¸å¿…ç­‰åˆ·æ–°)
                        const target = dbResults.value.find(s => 
                            s.studentName === scoreModal.value.studentName && 
                            s.studentClass === scoreModal.value.className && 
                            s.category === scoreModal.value.category
                        );
                        if (target) {
                            target.score = scoreModal.value.score;
                            target.rank = scoreModal.value.rank;
                        }
                        
                        await showDialog({ type: 'alert', title: 'ä¿å­˜æˆåŠŸ', message: 'æˆç»©å·²æ›´æ–°', icon: 'fas fa-check' });
                    } catch(e) {
                        console.error(e);
                        await showDialog({ type: 'alert', title: 'å¤±è´¥', message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', icon: 'fas fa-times' });
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                // --- è¾…åŠ©é€»è¾‘ ---
                const showDialog = (opts) => new Promise(resolve => {
                    modalState.value = { visible: true, type: opts.type || 'alert', title: opts.title || 'æç¤º', message: opts.message || '', placeholder: opts.placeholder || '', icon: opts.icon || 'fas fa-info-circle', resolve };
                    if(['prompt','password'].includes(opts.type)) nextTick(() => modalInput.value?.focus());
                });
                const handleModalConfirm = () => {
                    const val = modalState.value.type === 'confirm' ? true : modalState.value.inputValue;
                    modalState.value.resolve(val);
                    modalState.value.visible = false;
                };
                const handleModalCancel = () => {
                    modalState.value.resolve(false);
                    modalState.value.visible = false;
                };
                
                const enterAdmin = async () => {
                    if (isAdmin.value) { // å·²ç»æ˜¯ç®¡ç†å‘˜ï¼Œç‚¹å‡»è¿›å…¥åå°
                        currentTab.value = 'admin';
                        selectedCategory.value = null;
                        return;
                    }
                    const pwd = await showDialog({ type: 'password', title: 'åå°ç®¡ç†', message: 'è¾“å…¥ç®¡ç†å‘˜å¯†ç :', placeholder: 'è¾“å…¥ç®¡ç†å‘˜å¯†ç ', icon: 'fas fa-lock' });
                    if (pwd === "123456") {
                        isAdmin.value = true;
                        // è¯¢é—®æ˜¯å»åå°è¿˜æ˜¯ç•™åœ¨å¤§å…ç®¡ç†æˆç»©
                        const choice = await showDialog({ type: 'confirm', title: 'ç™»å½•æˆåŠŸ', message: 'è¦å»é¡¹ç›®ç®¡ç†åå°å—ï¼Ÿ\n(å–æ¶ˆåˆ™ç•™åœ¨å¤§å…è¿›è¡Œæˆç»©å½•å…¥)', icon: 'fas fa-user-shield' });
                        if (choice) {
                            currentTab.value = 'admin';
                            selectedCategory.value = null;
                        }
                    }
                    else if (pwd !== false) showDialog({ title: 'é”™è¯¯', message: 'å¯†ç é”™è¯¯' });
                };

                const groupedResults = computed(() => {
                    let filtered = dbResults.value;
                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        filtered = filtered.filter(i => JSON.stringify(i).toLowerCase().includes(q));
                    }
                    return competitionItems.value.map(cat => {
                        // å¢å¼ºåŒ¹é…ï¼šç¡®ä¿å»é™¤ç©ºæ ¼ååŒ¹é…
                        const students = filtered.filter(d => d.category && d.category.trim() === cat.trim());
                        if (searchQuery.value && students.length === 0) return null;
                        
                        const classMap = {};
                        students.forEach(s => {
                            const c = s.studentClass || 'æœªåˆ†ç±»';
                            if (!classMap[c]) classMap[c] = [];
                            classMap[c].push(s);
                        });
                        
                        return {
                            categoryName: cat,
                            totalCount: students.length,
                            classes: Object.keys(classMap).sort().map(c => ({ className: c, students: classMap[c] }))
                        };
                    }).filter(i => i);
                });

                const getSelectedGroupCount = () => groupedResults.value.find(g => g.categoryName === selectedCategory.value)?.totalCount || 0;
                
                // æŒ‰å¹´çº§åˆ†ç»„çš„è®¡ç®—å±æ€§
                const getSelectedGroupedByGrade = () => {
                    const group = groupedResults.value.find(g => g.categoryName === selectedCategory.value);
                    if (!group) return [];

                    const gradesMap = {};
                    group.classes.forEach(cls => {
                        const gradeChar = cls.className.charAt(0);
                        if (!gradesMap[gradeChar]) gradesMap[gradeChar] = [];
                        gradesMap[gradeChar].push(cls);
                    });

                    const gradeNames = {'1':'ä¸€å¹´çº§', '2':'äºŒå¹´çº§', '3':'ä¸‰å¹´çº§', '4':'å››å¹´çº§', '5':'äº”å¹´çº§', '6':'å…­å¹´çº§'};

                    return Object.keys(gradesMap).sort().map(g => ({
                        gradeLabel: gradeNames[g] || (g + 'å¹´çº§'),
                        classes: gradesMap[g] 
                    }));
                };

                const getCategoryIcon = (n) => {
                    if(n.includes('åè¯­')||n.includes('æ•…äº‹')) return 'fas fa-book-open';
                    if(n.includes('è‹±')||n.includes('æœ—è¯»')) return 'fas fa-language';
                    if(n.includes('ä¹¦')||n.includes('ç¬”')) return 'fas fa-pen-nib';
                    if(n.includes('ç”»')||n.includes('ç¾')) return 'fas fa-palette';
                    if(n.includes('ç®—')||n.includes('æ•°')||n.includes('æœº')) return 'fas fa-calculator';
                    if(n.includes('æ­Œ')||n.includes('å”±')||n.includes('èˆ')) return 'fas fa-microphone-alt';
                    if(n.includes('è·‘')||n.includes('çƒ')||n.includes('ä½“')) return 'fas fa-running';
                    return 'fas fa-trophy';
                };
                
                const getRankClass = (rank) => {
                    if (rank.includes('å† ')) return 'bg-yellow-100 text-yellow-700 border border-yellow-200';
                    if (rank.includes('äºš')) return 'bg-gray-200 text-gray-700 border border-gray-300';
                    if (rank.includes('å­£')) return 'bg-orange-100 text-orange-700 border border-orange-200';
                    if (rank.includes('ç‰¹ä¼˜')) return 'bg-purple-100 text-purple-700 border border-purple-200';
                    return 'bg-blue-50 text-blue-600 border border-blue-100';
                };

                return {
                    currentTab, selectedCategory, isInitializing, isRefreshing, isSubmitting, initStatus, isAdmin,
                    competitionItems, availableClasses: computed(() => classList.value), availableStudents: computed(() => studentDB.value[form.value.stuClass] || []),
                    form, searchQuery, keepClassInfo, adminNewItem,
                    goHome: () => { currentTab.value = 'results'; selectedCategory.value = null; },
                    goToRegister: (cat) => { currentTab.value = 'register'; form.value.category = cat; },
                    groupedResults, getSelectedGroupCount, getSelectedGroupedByGrade, getCategoryIcon, getRankClass,
                    modalState, handleModalConfirm, handleModalCancel, modalInput,
                    scoreModal, openScoreModal, submitScore,
                    enterAdmin, adminAddItem, adminDeleteItem, submitForm, fetchAllData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
