<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°å»Šåå°æ ¡å†…ç«èµ›ç³»ç»Ÿ</title>
    
    <!-- PWA é…ç½®æ”¯æŒ -->
    <meta name="theme-color" content="#f97316">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æ ¡å†…ç«èµ›">
    <link rel="apple-touch-icon" href="https://api.iconify.design/fxemoji/trophy.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- å¼•å…¥éœé¹œæ–‡æ¥·å±å¹•é˜…è¯»ç‰ˆ (ä½¿ç”¨ jsDelivr CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai&display=swap" rel="stylesheet">
    
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95); }
        
        body, button, input, select, textarea { 
            font-family: "LXGW WenKai Screen", "LXGW WenKai", KaiTi, "æ¥·ä½“", STKaiti, "åæ–‡æ¥·ä½“", serif !important; 
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            #app { min-height: auto; }
        }
    </style>
</head>
<body class="bg-yellow-50 text-gray-800">

    <div id="app" class="min-h-screen flex flex-col">
        
        <!-- Navbar -->
        <nav class="bg-orange-500 text-white shadow-lg sticky top-0 z-40 no-print">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div @click="goHome" class="flex items-center space-x-2 cursor-pointer group">
                    <i class="fas fa-shapes text-yellow-200 text-2xl group-hover:scale-110 transition"></i>
                    <div>
                        <h1 class="text-lg font-bold leading-tight">æ–°å»Šåå°æ ¡å†…ç«èµ›ç³»ç»Ÿ</h1>
                        <p class="text-xs text-orange-100 opacity-90">äº‘ç«¯å®æ—¶ç‰ˆ</p>
                    </div>
                </div>
                <div class="flex space-x-2 text-sm font-bold">
                    <button @click="goHome" :class="{'bg-white text-orange-600 shadow-md': currentTab === 'results'}" class="px-3 py-2 rounded-lg transition duration-200 flex items-center hover:bg-orange-400">
                        <i class="fas fa-home mr-1"></i> å¤§å…
                    </button>
                    <button @click="enterAdmin" :class="{'bg-gray-800 text-yellow-400 shadow-md': currentTab === 'admin' || isAdmin}" class="px-3 py-2 rounded-lg transition duration-200 flex items-center border border-orange-400 hover:bg-orange-600">
                        <i class="fas" :class="isAdmin ? 'fa-user-shield' : 'fa-cogs'"></i> <span class="ml-1">{{ isAdmin ? 'ç®¡ç†å‘˜' : 'ç®¡ç†' }}</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Toast é£˜çª—æç¤º (ğŸˆ ä¼˜åŒ–) -->
        <transition name="fade">
            <div v-if="toastState.visible" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-[120] px-6 py-3 rounded-full shadow-lg font-bold text-sm flex items-center transition-all duration-300"
                 :class="toastState.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'">
                <i :class="toastState.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'" class="mr-2"></i>
                {{ toastState.message }}
            </div>
        </transition>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-6 max-w-5xl">

            <!-- å…¨å±€åŠ è½½çŠ¶æ€ -->
            <div v-if="isInitializing" class="fixed inset-0 bg-yellow-50 z-50 flex flex-col items-center justify-center no-print">
                <div class="loader w-12 h-12 border-4 border-orange-200 border-t-orange-500 mb-4"></div>
                <p class="text-orange-600 font-bold animate-pulse">æ­£åœ¨è¿æ¥ Google Database...</p>
                <div class="text-xs text-gray-400 mt-2 space-y-1">
                    <p><i class="fas" :class="initStatus.items ? 'fa-check text-green-500' : 'fa-spinner fa-spin'"></i> æ¯”èµ›é¡¹ç›®</p>
                    <p><i class="fas" :class="initStatus.students ? 'fa-check text-green-500' : 'fa-spinner fa-spin'"></i> å­¦ç”Ÿåå•</p>
                    <p><i class="fas" :class="initStatus.results ? 'fa-check text-green-500' : 'fa-spinner fa-spin'"></i> æŠ¥åè®°å½•</p>
                </div>
            </div>

            <!-- TAB 1: æ¯”èµ›å¤§å… -->
            <transition name="fade" mode="out-in">
                <div v-if="currentTab === 'results'" key="results" class="space-y-6">
                    <!-- å·¥å…·æ  -->
                    <div class="flex flex-row gap-3 items-center justify-between no-print">
                        <h2 v-if="!selectedCategory" class="text-xl font-bold text-gray-700 hidden sm:block">
                            <i class="fas fa-bullhorn text-orange-500 mr-2"></i>æ¯”èµ›å¤§å…
                        </h2>
                        <div class="flex-grow flex gap-2 justify-end items-center">
                             <div class="flex items-center text-xs text-orange-400/80 mr-1 bg-white px-2 py-1 rounded-full border border-orange-100 shadow-sm hidden sm:flex">
                                <span class="relative flex h-2 w-2 mr-2">
                                  <span :class="isInitializing ? 'bg-gray-300' : 'bg-green-400 animate-ping'" class="absolute inline-flex h-full w-full rounded-full opacity-75"></span>
                                  <span :class="isInitializing ? 'bg-gray-400' : 'bg-green-500'" class="relative inline-flex rounded-full h-2 w-2"></span>
                                </span>
                                {{ isInitializing ? 'è¿æ¥ä¸­...' : 'å®æ—¶åŒæ­¥' }}
                            </div>

                             <div class="relative w-full max-w-xs sm:max-w-md">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input v-model="searchQuery" type="text" placeholder="æœå§“åã€ç­çº§æˆ–é¡¹ç›®..." 
                                    class="w-full border border-orange-200 rounded-full pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300 transition bg-white shadow-sm">
                            </div>
                            <button @click="fetchAllData(false)" class="bg-white text-orange-600 px-3 py-2 rounded-full shadow-sm border border-orange-100 hover:bg-orange-50 transition font-bold text-sm whitespace-nowrap" title="ç«‹å³åˆ·æ–°">
                                <i class="fas fa-sync-alt" :class="{'fa-spin': isRefreshing}"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ç®¡ç†å‘˜æç¤ºæ¡ -->
                    <div v-if="isAdmin" class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded-r shadow-sm flex justify-between items-center text-sm no-print">
                        <span class="text-blue-700"><i class="fas fa-info-circle mr-1"></i> æ‚¨å¤„äºç®¡ç†å‘˜æ¨¡å¼ã€‚</span>
                        <button @click="isAdmin=false; isBatchEditing=false; currentTab='results'" class="text-blue-400 hover:text-blue-600 underline text-xs">é€€å‡ºç®¡ç†</button>
                    </div>

                    <!-- è§†å›¾ A: æ¯”èµ›é¡¹ç›®åˆ—è¡¨ -->
                    <div v-if="!selectedCategory">
                        <div v-if="isInitializing" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 animate-pulse">
                            <div v-for="n in 6" :key="n" class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 flex flex-col items-center text-center h-48">
                                <div class="w-16 h-16 rounded-full bg-gray-200 mb-4"></div>
                                <div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div>
                                <div class="mt-auto w-full pt-2">
                                    <div class="h-4 bg-gray-200 rounded w-1/3 mx-auto"></div>
                                </div>
                            </div>
                        </div>

                        <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div v-for="group in groupedResults" :key="group.categoryName" 
                                 @click="selectedCategory = group.categoryName"
                                 class="bg-white rounded-2xl shadow-md border-2 border-transparent hover:border-orange-400 hover:shadow-xl transition cursor-pointer p-6 flex flex-col items-center text-center group h-full transform hover:-translate-y-1">
                                <div class="w-16 h-16 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-3xl mb-4 shadow-inner">
                                    <i :class="getCategoryIcon(group.categoryName)"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 mb-2">{{ group.categoryName }}</h3>
                                <div class="mt-auto w-full pt-2">
                                    <span class="text-xs font-bold text-white bg-green-500 px-2 py-0.5 rounded-full shadow-sm">è¿›è¡Œä¸­</span>
                                    <div class="text-gray-500 text-sm mt-2">å·²æŠ¥: <span class="text-xl font-bold text-orange-600">{{ group.totalCount }}</span> äºº</div>
                                </div>
                            </div>

                            <div v-if="groupedResults.length === 0" class="col-span-full text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-300">
                                <p class="text-gray-500 mb-4">æš‚æ— æ¯”èµ›é¡¹ç›®</p>
                                <button @click="enterAdmin" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm">å‰å¾€åå°æ·»åŠ </button>
                            </div>
                        </div>
                    </div>

                    <!-- è§†å›¾ B: é¡¹ç›®è¯¦æƒ…é¡µ -->
                    <div v-else class="space-y-6">
                        <!-- è¯¦æƒ…é¡µHeader -->
                        <div class="flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-orange-100 sticky top-16 z-30 no-print">
                            <div class="flex items-center">
                                <button @click="exitCategory" class="text-gray-600 hover:text-orange-600 font-bold flex items-center bg-gray-100 px-3 py-1.5 rounded-lg text-sm mr-3">
                                    <i class="fas fa-arrow-left mr-2"></i> è¿”å›
                                </button>
                                <div>
                                    <h2 class="text-lg font-bold text-gray-800">{{ selectedCategory }}</h2>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span v-if="getSelectedGroupOrganizer()" class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">
                                            <i class="fas fa-building mr-1"></i> ä¸»åŠ: {{ getSelectedGroupOrganizer() }}
                                        </span>
                                        <span v-if="isBatchEditing" class="text-xs text-red-500 font-bold animate-pulse">â— å½•å…¥æ¨¡å¼</span>
                                    </div>
                                </div>
                            </div>
                            <div v-if="!isBatchEditing" class="text-sm bg-orange-100 text-orange-700 px-3 py-1 rounded-full font-bold">{{ getSelectedGroupCount() }} äºº</div>
                        </div>

                        <!-- è¯¦æƒ…é¡µæ•°æ®ç©º -->
                        <div v-if="getSelectedGroupCount() === 0" class="text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-200 no-print">
                            <p class="text-gray-500 mb-4">æš‚æ— æŠ¥åè®°å½•</p>
                            <button @click="goToRegister(selectedCategory)" class="bg-orange-500 text-white px-6 py-2 rounded-full font-bold shadow hover:bg-orange-600">å»æŠ¥å</button>
                        </div>

                        <!-- è¯¦æƒ…é¡µæ•°æ®åˆ—è¡¨ -->
                        <div v-else>
                            <!-- æ“ä½œæŒ‰é’®ç»„ -->
                            <div v-if="!isBatchEditing" class="mb-6 flex flex-wrap justify-end gap-3 no-print">
                                <button v-if="isAdmin" @click="startBatchEdit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow text-sm flex items-center transition animate-bounce-once">
                                    <i class="fas fa-pencil-alt mr-2"></i> æ‰¹é‡å½•å…¥æˆç»©
                                </button>
                                <!-- å¯¼å‡º CSV åŠŸèƒ½ -->
                                <button @click="exportCSV" class="bg-green-50 border border-green-200 text-green-700 hover:bg-green-100 px-4 py-2 rounded-lg font-bold shadow-sm text-sm flex items-center transition">
                                    <i class="fas fa-file-excel mr-2"></i> å¯¼å‡ºExcel
                                </button>

                                <!-- æ–°å¢ï¼šæ‰“å°åŠŸèƒ½ä¸‹æ‹‰èœå• -->
                                <div class="relative group inline-block">
                                    <button class="bg-white border border-gray-300 text-gray-700 group-hover:bg-gray-50 px-4 py-2 rounded-lg font-bold shadow-sm text-sm flex items-center transition h-full">
                                        <i class="fas fa-print mr-2"></i> æ‰“å°é€‰é¡¹ <i class="fas fa-chevron-down ml-2 text-xs"></i>
                                    </button>
                                    <div class="absolute right-0 mt-1 w-44 bg-white rounded-xl shadow-xl border border-gray-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 overflow-hidden">
                                        <button @click="printRoster" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition flex items-center border-b border-gray-50">
                                            <i class="fas fa-list-ol w-5 text-center mr-2 text-blue-500"></i> ç©ºç™½åå•
                                        </button>
                                        <button @click="printScoringSheet" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition flex items-center border-b border-gray-50">
                                            <i class="fas fa-clipboard-check w-5 text-center mr-2 text-orange-500"></i> è¯„åˆ†è®°å½•è¡¨
                                        </button>
                                        <button @click="printResults" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-yellow-50 hover:text-yellow-600 transition flex items-center">
                                            <i class="fas fa-trophy w-5 text-center mr-2 text-yellow-500"></i> å¾—å¥–åå•
                                        </button>
                                    </div>
                                </div>

                                <button @click="goToRegister(selectedCategory)" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-bold shadow text-sm flex items-center transition">
                                    <i class="fas fa-plus-circle mr-2"></i> æ–°å¢æŠ¥å
                                </button>
                            </div>

                            <!-- æ‰¹é‡ç¼–è¾‘çš„æ“ä½œæ  (Sticky Footer) -->
                            <div v-if="isBatchEditing" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg p-4 z-50 flex justify-between items-center no-print">
                                <div class="text-sm text-gray-600">
                                    <span v-if="isSubmitting"><i class="fas fa-spinner fa-spin mr-2"></i>æ­£åœ¨ä¿å­˜...</span>
                                    <span v-else>å·²è¿›å…¥æ‰¹é‡å½•å…¥æ¨¡å¼ï¼Œä¿®æ”¹åè¯·ç‚¹å‡»ä¿å­˜ã€‚</span>
                                </div>
                                <div class="flex gap-3">
                                    <button @click="cancelBatchEdit" :disabled="isSubmitting" class="px-6 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg font-bold">å–æ¶ˆ</button>
                                    <button @click="saveBatchEdit" :disabled="isSubmitting" class="px-6 py-2 bg-green-600 text-white hover:bg-green-700 rounded-lg font-bold shadow-lg transform active:scale-95 transition">
                                        <i class="fas fa-save mr-2"></i> ä¿å­˜å…¨éƒ¨
                                    </button>
                                </div>
                            </div>

                            <!-- æŒ‰å¹´çº§åˆ†ç»„å¾ªç¯ -->
                            <div v-for="(gradeGroup, gIndex) in (isBatchEditing ? batchEditData : getSelectedGroupedByGrade())" :key="gIndex" class="mb-8 break-inside-avoid">
                                <!-- å¹´çº§æ ‡é¢˜ -->
                                <div class="flex items-center mb-4">
                                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold text-sm shadow-sm border border-blue-200">
                                        {{ gradeGroup.gradeLabel }} (å…± {{ gradeGroup.totalStudents }} äºº)
                                    </span>
                                    <div class="h-px bg-blue-100 flex-grow ml-4 no-print"></div>
                                </div>

                                <!-- æ™®é€šæ¨¡å¼ï¼šGrid å¡ç‰‡ -->
                                <div v-if="!isBatchEditing" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div v-for="cls in gradeGroup.classes" :key="cls.className" class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm relative overflow-hidden break-inside-avoid">
                                        <div class="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                                            <span class="font-bold text-blue-600 text-lg">{{ cls.className }}</span>
                                            <span class="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-bold">{{ cls.students.length }}äºº</span>
                                        </div>
                                        <ul class="space-y-2">
                                            <li v-for="stu in cls.students" :key="stu.rowIndex" class="flex justify-between items-center text-sm p-2 rounded hover:bg-gray-50 transition group">
                                                <span class="font-medium text-gray-700 flex items-center">{{ stu.studentName }}</span>
                                                <div class="flex items-center gap-1">
                                                    <span v-if="stu.rank" :class="getRankClass(stu.rank)" class="text-xs px-2 py-0.5 rounded font-bold scale-90 whitespace-nowrap">{{ stu.rank }}</span>
                                                    <span v-else-if="stu.score" class="text-gray-500 font-mono text-xs bg-gray-100 px-1 rounded">{{ stu.score }}åˆ†</span>
                                                    
                                                    <!-- æ’¤é”€/åˆ é™¤æŠ¥åæŒ‰é’® -->
                                                    <button v-if="isAdmin" @click.stop="deleteRegistration(stu, cls.className)" class="text-gray-300 hover:text-red-500 p-1 transition opacity-0 group-hover:opacity-100 no-print" title="åˆ é™¤æŠ¥å">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>

                                                    <button v-if="isAdmin" @click.stop="openScoreModal(stu, cls.className)" class="text-gray-300 hover:text-blue-500 p-1 transition opacity-0 group-hover:opacity-100 no-print" title="å½•å…¥æˆç»©">
                                                        <i class="fas fa-pencil-alt"></i>
                                                    </button>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- æ‰¹é‡ç¼–è¾‘æ¨¡å¼ï¼šè¡¨æ ¼è§†å›¾ -->
                                <div v-else class="bg-white rounded-xl border border-blue-200 shadow-sm overflow-hidden">
                                    <table class="w-full text-left border-collapse">
                                        <thead class="bg-blue-50 text-blue-800 text-xs uppercase">
                                            <tr>
                                                <th class="p-3 border-b border-blue-100">ç­çº§</th>
                                                <th class="p-3 border-b border-blue-100">å§“å</th>
                                                <th class="p-3 border-b border-blue-100 w-24">åˆ†æ•°</th>
                                                <th class="p-3 border-b border-blue-100 w-32">åæ¬¡</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100">
                                            <template v-for="cls in gradeGroup.classes" :key="cls.className">
                                                <tr v-for="stu in cls.students" :key="stu.rowIndex" class="hover:bg-yellow-50 transition">
                                                    <td class="p-3 font-mono text-gray-500 text-sm">{{ cls.className }}</td>
                                                    <td class="p-3 font-medium text-gray-800">{{ stu.studentName }}</td>
                                                    <td class="p-2">
                                                        <input type="text" v-model="stu.score" class="w-full border border-gray-300 rounded px-2 py-1 text-sm text-center focus:ring-2 focus:ring-blue-500 outline-none" placeholder="-">
                                                    </td>
                                                    <td class="p-2">
                                                        <select v-model="stu.rank" class="w-full border border-gray-300 rounded px-2 py-1 text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                                            <option value="">(æ— )</option>
                                                            <option value="å† å†›">å† å†›</option>
                                                            <option value="äºšå†›">äºšå†›</option>
                                                            <option value="å­£å†›">å­£å†›</option>
                                                            <option value="ç¬¬å››å">ç¬¬å››å</option>
                                                            <option value="ç¬¬äº”å">ç¬¬äº”å</option>
                                                            <option value="ç‰¹ä¼˜å¥–">ç‰¹ä¼˜å¥–</option>
                                                            <option value="ä¼˜ç§€å¥–">ä¼˜ç§€å¥–</option>
                                                            <option value="å®‰æ…°å¥–">å®‰æ…°å¥–</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                            <!-- åº•éƒ¨ç•™ç™½ç»™ Sticky Footer -->
                            <div v-if="isBatchEditing" class="h-20"></div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- TAB 2: æŠ¥åé¡µé¢ -->
            <transition name="fade" mode="out-in">
                <div v-if="currentTab === 'register'" key="register" class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-6 border-t-4 border-orange-400 no-print">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-start">
                            <div class="bg-orange-100 p-3 rounded-full mr-4"><i class="fas fa-user-edit text-orange-500 text-xl"></i></div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">æŠ¥åå½•å…¥</h2>
                                <p class="text-gray-500 text-sm">æ‰€æœ‰é€‰é¡¹å‡æ¥è‡ª Google Sheets å®æ—¶æ•°æ®</p>
                            </div>
                        </div>
                        <button @click="goHome" class="text-gray-400 hover:text-gray-600 text-sm underline">å–æ¶ˆ</button>
                    </div>

                    <!-- æŠ¥åé¡µéª¨æ¶å± -->
                    <div v-if="isInitializing" class="space-y-6 animate-pulse">
                        <div class="h-20 bg-gray-200 rounded-xl"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="h-32 bg-gray-200 rounded-xl"></div>
                            <div class="h-32 bg-gray-200 rounded-xl"></div>
                        </div>
                    </div>

                    <form v-else @submit.prevent="submitForm" class="space-y-6">
                        <!-- é¡¹ç›® -->
                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                            <label class="block text-sm font-bold text-gray-700 mb-2">å‚èµ›é¡¹ç›®</label>
                            <select v-model="form.category" required class="w-full rounded-lg border-2 border-yellow-300 p-3 outline-none bg-white font-medium text-gray-800">
                                <option value="" disabled>è¯·é€‰æ‹©...</option>
                                <option v-for="item in competitionItems" :key="item.name" :value="item.name">{{ item.name }}</option>
                            </select>
                            <p v-if="competitionItems.length === 0" class="text-xs text-red-500 mt-2">* æš‚æ— é¡¹ç›®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜åœ¨åå°æ·»åŠ ã€‚</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <!-- ç­çº§ -->
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 h-fit">
                                <label class="block text-sm font-bold text-blue-800 mb-2">æ‰€å±ç­çº§</label>
                                <select v-model="form.stuClass" required class="w-full rounded-lg border-2 border-blue-200 p-3 outline-none bg-white font-mono text-lg">
                                    <option value="" disabled>é€‰æ‹©ç­çº§</option>
                                    <option v-for="cls in availableClasses" :key="cls" :value="cls">{{ cls }}</option>
                                </select>
                                <div class="mt-2 text-xs text-gray-500">
                                    <label class="flex items-center"><input type="checkbox" v-model="keepClassInfo" class="mr-1"> è¿ç»­æŠ¥åä¿ç•™ç­çº§</label>
                                </div>
                                <div v-if="availableClasses.length === 0" class="text-xs text-red-400 mt-2">
                                    * æœªåŠ è½½åˆ°ç­çº§ï¼Œè¯·æ£€æŸ¥ "Students" è¡¨æ ¼ã€‚
                                </div>
                            </div>

                            <!-- å­¦ç”Ÿ -->
                            <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                                <label class="block text-sm font-bold text-green-800 mb-2">é€‰æ‹©å­¦ç”Ÿ (æœ€å¤š3äºº)</label>
                                <div v-if="!form.stuClass" class="text-gray-400 text-sm py-8 text-center border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">â† å…ˆé€‰ç­çº§</div>
                                <div v-else class="space-y-3">
                                    <div v-for="(sel, idx) in form.selectedStudents" :key="idx" class="relative">
                                        <span class="absolute left-3 top-3 text-xs font-bold text-gray-400">{{ idx + 1 }}.</span>
                                        <select v-model="form.selectedStudents[idx]" class="w-full rounded-lg border border-green-200 pl-8 p-2 bg-white outline-none focus:border-green-500">
                                            <option value="">(ç©º)</option>
                                            <option v-for="stuName in availableStudents" :key="stuName" :value="stuName">{{ stuName }}</option>
                                        </select>
                                    </div>
                                    <div class="text-right">
                                        <button type="button" @click="form.selectedStudents = ['', '', '']" class="text-xs text-gray-400 hover:text-red-500 underline">æ¸…ç©º</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" :disabled="isSubmitting" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform active:scale-95 transition disabled:opacity-60 disabled:cursor-not-allowed">
                            <span v-if="isSubmitting" class="loader inline-block mr-2 w-4 h-4 border-2 border-white border-t-transparent"></span>
                            {{ isSubmitting ? 'æäº¤ä¸­...' : 'ç¡®è®¤æŠ¥å' }}
                        </button>
                    </form>
                </div>
            </transition>

            <!-- TAB 3: ç®¡ç†åå° -->
            <transition name="fade" mode="out-in">
                <div v-if="currentTab === 'admin'" key="admin" class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200 no-print">
                    <div class="bg-gray-800 text-white p-6 flex justify-between items-center">
                        <h2 class="text-xl font-bold"><i class="fas fa-cogs text-yellow-400 mr-2"></i>é¡¹ç›®ç®¡ç†åå°</h2>
                        <button @click="goHome"><i class="fas fa-times hover:text-gray-300"></i></button>
                    </div>
                    <div class="p-6">
                        <div class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <label class="block text-sm font-bold text-gray-700 mb-2">æ·»åŠ æ–°é¡¹ç›® (åŒæ­¥è‡³äº‘ç«¯)</label>
                            <div class="flex gap-2">
                                <input v-model="adminNewItemName" :disabled="isSubmitting" type="text" placeholder="æ¯”èµ›åç§° (å¦‚ï¼šæœºå™¨äººå¤§èµ›)" class="flex-grow border border-gray-300 rounded-lg px-4 py-2 outline-none focus:border-green-500">
                                <input v-model="adminNewItemOrg" :disabled="isSubmitting" @keyup.enter="adminAddItem" type="text" placeholder="ä¸»åŠå•ä½ (é€‰å¡«)" class="w-1/3 border border-gray-300 rounded-lg px-4 py-2 outline-none focus:border-green-500">
                                <button @click="adminAddItem" :disabled="isSubmitting" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50 whitespace-nowrap">
                                    <i v-if="isSubmitting" class="fas fa-spinner fa-spin"></i> æ·»åŠ 
                                </button>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-700 mb-3">äº‘ç«¯é¡¹ç›®åˆ—è¡¨ ({{ competitionItems.length }})</h3>
                            
                            <!-- åå°åŠ è½½éª¨æ¶å± -->
                            <div v-if="isInitializing" class="space-y-2 animate-pulse">
                                <div v-for="n in 3" :key="n" class="h-12 bg-gray-200 rounded-lg"></div>
                            </div>

                            <div v-else-if="competitionItems.length === 0" class="text-center py-8 text-gray-400 bg-gray-50 rounded-lg border-2 border-dashed">
                                æš‚æ— æ¯”èµ›é¡¹ç›®ï¼Œè¯·åœ¨ä¸Šæ–¹è¾“å…¥åç§°å¹¶ç‚¹å‡»æ·»åŠ 
                            </div>

                            <ul v-else class="space-y-2 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                <li v-for="(item, index) in competitionItems" :key="index" class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-lg shadow-sm hover:shadow-md transition">
                                    <div class="flex items-center">
                                        <i :class="getCategoryIcon(item.name)" class="text-orange-400 mr-3 w-6 text-center"></i>
                                        <div class="flex flex-col">
                                            <span class="font-bold text-gray-800">{{ item.name }}</span>
                                            <span v-if="item.organizer" class="text-xs text-gray-400">ä¸»åŠ: {{ item.organizer }}</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="openEditCategory(item)" :disabled="isSubmitting" class="text-gray-400 hover:text-blue-500 p-2" title="ä¿®æ”¹"><i class="fas fa-edit"></i></button>
                                        <button @click="adminDeleteItem(item.name)" :disabled="isSubmitting" class="text-gray-400 hover:text-red-500 p-2" title="åˆ é™¤"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </transition>

        </main>

        <!-- é€šç”¨ Modal (Alert/Confirm/Prompt) -->
        <transition name="modal">
            <div v-if="modalState.visible" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm no-print" @click.self="handleModalCancel">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden">
                    <div class="bg-orange-500 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="font-bold text-lg"><i :class="modalState.icon"></i> {{ modalState.title }}</h3>
                        <button @click="handleModalCancel"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4 whitespace-pre-line">{{ modalState.message }}</p>
                        <input v-if="['prompt', 'password'].includes(modalState.type)" :type="modalState.type === 'password' ? 'password' : 'text'" v-model="modalState.inputValue" @keyup.enter="handleModalConfirm" ref="modalInput" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 outline-none focus:border-orange-500" :placeholder="modalState.placeholder">
                    </div>
                    <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                        <button v-if="modalState.type !== 'alert'" @click="handleModalCancel" class="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded-lg text-sm font-bold">å–æ¶ˆ</button>
                        <button @click="handleModalConfirm" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-sm font-bold">ç¡®å®š</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- ç¼–è¾‘æ¯”èµ›é¡¹ç›®ä¸“ç”¨ Modal -->
        <transition name="modal">
            <div v-if="editCategoryModal.visible" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/50 backdrop-blur-sm no-print">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden transform transition-all">
                    <div class="bg-blue-600 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="font-bold text-lg"><i class="fas fa-edit mr-2"></i>ä¿®æ”¹æ¯”èµ›é¡¹ç›®</h3>
                        <button @click="editCategoryModal.visible = false"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">æ¯”èµ›åç§° <span class="text-red-500">*</span></label>
                            <input type="text" v-model="editCategoryModal.newName" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">ä¸»åŠå•ä½</label>
                            <input type="text" v-model="editCategoryModal.organizer" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="å¦‚ï¼šæ•™åŠ¡å¤„">
                        </div>
                        <div class="bg-yellow-50 p-3 rounded text-xs text-yellow-800">
                            <i class="fas fa-info-circle mr-1"></i> æç¤ºï¼šä¿®æ”¹æ¯”èµ›åç§°ä¼šåŒæ­¥æ›´æ–°å·²æœ‰æŠ¥åè®°å½•ä¸­çš„é¡¹ç›®åç§°ã€‚
                        </div>
                    </div>
                    <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                        <button @click="editCategoryModal.visible = false" class="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded-lg text-sm font-bold">å–æ¶ˆ</button>
                        <button @click="submitEditCategory" :disabled="isSubmitting" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold disabled:opacity-50 flex items-center">
                            <i v-if="isSubmitting" class="fas fa-spinner fa-spin mr-2"></i> ä¿å­˜ä¿®æ”¹
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- æˆç»©å½•å…¥ä¸“ç”¨ Modal -->
        <transition name="modal">
            <div v-if="scoreModal.visible" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/50 backdrop-blur-sm no-print">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden transform transition-all">
                    <div class="bg-blue-600 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="font-bold text-lg"><i class="fas fa-medal mr-2"></i>æˆç»©å½•å…¥</h3>
                        <button @click="scoreModal.visible = false"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="bg-blue-50 p-3 rounded text-sm text-blue-800">
                            æ­£åœ¨ä¸º <strong>{{ scoreModal.className }}</strong> çš„ <strong>{{ scoreModal.studentName }}</strong> å½•å…¥æˆç»©ã€‚
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">åˆ†æ•° (å¯é€‰)</label>
                            <input type="text" v-model="scoreModal.score" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚: 95">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">å¥–é¡¹/åæ¬¡ (å¯é€‰)</label>
                            <select v-model="scoreModal.rank" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="">æ— </option>
                                <option value="å† å†›">ğŸ† å† å†›</option>
                                <option value="äºšå†›">ğŸ¥ˆ äºšå†›</option>
                                <option value="å­£å†›">ğŸ¥‰ å­£å†›</option>
                                <option value="ç¬¬å››å">4ï¸âƒ£ ç¬¬å››å</option>
                                <option value="ç¬¬äº”å">5ï¸âƒ£ ç¬¬äº”å</option>
                                <option value="ç‰¹ä¼˜å¥–">ğŸ… ç‰¹ä¼˜å¥–</option>
                                <option value="ä¼˜ç§€å¥–">ğŸ–ï¸ ä¼˜ç§€å¥–</option>
                                <option value="å®‰æ…°å¥–">ğŸ—ï¸ å®‰æ…°å¥–</option>
                            </select>
                        </div>

                        <!-- ğŸ”’ å¯†ç éªŒè¯ -->
                        <div>
                            <label class="block text-sm font-bold text-red-600 mb-1">æ“ä½œå¯†ç </label>
                            <input type="password" v-model="scoreModal.password" class="w-full border-2 border-red-100 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-red-500 bg-red-50" placeholder="è¯·è¾“å…¥å¯†ç ä»¥ä¿å­˜">
                        </div>
                    </div>
                    <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                        <button @click="scoreModal.visible = false" class="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded-lg text-sm font-bold">å–æ¶ˆ</button>
                        <button @click="submitScore" :disabled="isSubmitting" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold disabled:opacity-50 flex items-center">
                            <i v-if="isSubmitting" class="fas fa-spinner fa-spin mr-2"></i> ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;

        // âš ï¸ é‡è¦ï¼šæ›¿æ¢ä¸ºä½ æœ€æ–°çš„ Web App URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbygUvrWzIWQc49EFoBKrE_bdP1g-KN1Jba294oC3mEmhgO3glenq4gl4YXmYof-8tDs/exec"; 

        createApp({
            setup() {
                // State
                const currentTab = ref('results');
                const selectedCategory = ref(null);
                const isInitializing = ref(true);
                const isRefreshing = ref(false);
                const isSubmitting = ref(false);
                const isAdmin = ref(false); 
                const isBatchEditing = ref(false); 
                
                const initStatus = ref({ items: false, students: false, results: false });
                
                // Data from Cloud
                const competitionItems = ref([]);
                const studentDB = ref({});
                const classList = ref([]);
                const dbResults = ref([]);
                const batchEditData = ref([]); 
                
                // Forms
                const form = ref({ stuClass: '', category: '', selectedStudents: ['', '', ''] });
                const keepClassInfo = ref(true);
                const adminNewItemName = ref('');
                const adminNewItemOrg = ref('');
                const searchQuery = ref('');

                // ğŸ‘¨â€ğŸ“ ä¼˜åŒ–ï¼šè·¨ç­çº§æ¸…ç©ºé€‰äººä¿æŠ¤ (é˜²æ­¢å­¦ç”Ÿè¢«æŠ¥åˆ°é”™çš„ç­çº§)
                watch(() => form.value.stuClass, (newVal, oldVal) => {
                    if (newVal !== oldVal) {
                        form.value.selectedStudents = ['', '', ''];
                    }
                });

                // Modals & Toasts
                const modalState = ref({ visible: false, type: 'alert', title: '', message: '', inputValue: '', placeholder: '', icon: '', resolve: null });
                const modalInput = ref(null);
                const toastState = ref({ visible: false, message: '', type: 'success' });
                
                // Score Modal 
                const scoreModal = ref({ visible: false, studentName: '', className: '', score: '', rank: '', category: '', password: '' });
                // Edit Category Modal
                const editCategoryModal = ref({ visible: false, oldName: '', newName: '', organizer: '' });

                let autoRefreshTimer = null;
                let toastTimer = null;

                // --- ğŸ“± PWA åŒ–é…ç½®æ³¨å†Œ ---
                const initPWA = () => {
                    const manifest = {
                        name: "æ–°å»Šåå°æ ¡å†…ç«èµ›ç³»ç»Ÿ",
                        short_name: "ç«èµ›ç³»ç»Ÿ",
                        start_url: window.location.href.split('?')[0],
                        display: "standalone",
                        background_color: "#fffbeb",
                        theme_color: "#f97316",
                        icons: [{
                            src: "https://api.iconify.design/fxemoji/trophy.png",
                            sizes: "512x512",
                            type: "image/png",
                            purpose: "any maskable"
                        }]
                    };
                    const manifestStr = JSON.stringify(manifest);
                    const manifestDataUrl = `data:application/manifest+json;charset=utf-8,${encodeURIComponent(manifestStr)}`;
                    document.head.insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestDataUrl}">`);
                };

                // --- ğŸˆ è½»é‡çº§æç¤º (Toast) ---
                const showToast = (message, type = 'success') => {
                    toastState.value = { visible: true, message, type };
                    if (toastTimer) clearTimeout(toastTimer);
                    toastTimer = setTimeout(() => { toastState.value.visible = false; }, 2500);
                };

                // --- API äº¤äº’æ ¸å¿ƒ ---
                const fetchAPI = async (action, payload = null) => {
                    if (GOOGLE_SCRIPT_URL.includes("åœ¨æ­¤å¤„ç²˜è´´")) throw new Error("API URL æœªé…ç½®");
                    try {
                        if (payload) { // POST
                            const response = await fetch(GOOGLE_SCRIPT_URL, {
                                method: 'POST',
                                mode: 'no-cors', 
                                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                                body: JSON.stringify({ action, ...payload })
                            });
                            return response; 
                        } else { // GET
                            const timestamp = new Date().getTime();
                            const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=${action}&_t=${timestamp}`, {
                                method: 'GET',
                                redirect: 'follow'
                            });
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return await response.json();
                        }
                    } catch (error) {
                        console.error("API Error:", error);
                        if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                            throw new Error("è·¨åŸŸè¯·æ±‚è¢«æ‹’ç» (CORS)ã€‚\n\nè¯·æ£€æŸ¥ Apps Script æƒé™ï¼š\nã€Œæ‰§è¡Œèº«ä»½ã€ä¸ºã€Œæˆ‘ã€ï¼›ã€Œè°å¯ä»¥è®¿é—®ã€ä¸ºã€Œä»»ä½•äººã€");
                        }
                        throw error;
                    }
                };

                // --- æ™ºèƒ½æ•°æ®æ¸…æ´— ---
                const normalizeData = (rawData) => {
                    if (!Array.isArray(rawData)) return [];
                    return rawData.map(item => {
                        const newItem = {};
                        Object.keys(item).forEach(key => {
                            const k = key.toLowerCase().replace(/\s+/g, '');
                            if (['studentname', 'name', 'å§“å', 'å­¦ç”Ÿå§“å', 'å­¦ç”Ÿ'].includes(k)) newItem.studentName = item[key];
                            else if (['studentclass', 'class', 'ç­çº§'].includes(k)) newItem.studentClass = item[key];
                            else if (['category', 'competition', 'é¡¹ç›®', 'æ¯”èµ›é¡¹ç›®', 'æ¯”èµ›'].includes(k)) newItem.category = item[key];
                            else if (['score', 'åˆ†æ•°', 'æˆç»©'].includes(k)) newItem.score = item[key];
                            else if (['rank', 'ranking', 'åæ¬¡', 'å¥–é¡¹', 'æ’å'].includes(k)) newItem.rank = item[key];
                            else newItem[key] = item[key];
                        });
                        if(!newItem.studentName) newItem.studentName = newItem.Name || '';
                        if(!newItem.studentClass) newItem.studentClass = newItem.Class || '';
                        if(!newItem.category) newItem.category = newItem.Category || '';
                        return newItem;
                    });
                };

                const fetchAllData = async (isBackground = false) => {
                    if (isBatchEditing.value && isBackground) return;
                    if (!isBackground) isRefreshing.value = true;
                    try {
                        const items = await fetchAPI('getCompetitions');
                        const normalizedItems = Array.isArray(items) 
                            ? items.map(i => typeof i === 'string' ? {name: i, organizer: ''} : i)
                            : [];
                        competitionItems.value = normalizedItems;
                        initStatus.value.items = true;

                        const rawStudents = await fetchAPI('getStudents');
                        const cleanedStudents = normalizeData(rawStudents);
                        const db = {};
                        cleanedStudents.forEach(s => {
                            if(s.studentClass && s.studentName) {
                                if (!db[s.studentClass]) db[s.studentClass] = [];
                                db[s.studentClass].push(s.studentName);
                            }
                        });
                        studentDB.value = db;
                        classList.value = Object.keys(db).sort();
                        initStatus.value.students = true;

                        const rawResults = await fetchAPI('getResults');
                        const cleanedResults = normalizeData(rawResults);
                        dbResults.value = cleanedResults.map((item, i) => ({ ...item, rowIndex: i }));
                        initStatus.value.results = true;
                        
                    } catch (e) {
                        console.error(e);
                        if (!isBackground && e.message !== "API URL æœªé…ç½®") {
                           await showDialog({ type: 'alert', title: 'æ•°æ®åº“è¿æ¥å¤±è´¥', message: e.message, icon: 'fas fa-exclamation-triangle' });
                        }
                    } finally {
                        isInitializing.value = false;
                        if (!isBackground) isRefreshing.value = false;
                    }
                };

                const initItemsFromStorage = () => {
                    const stored = localStorage.getItem('school_competition_items');
                    if (stored) {
                        try {
                            const parsed = JSON.parse(stored);
                            if (!Array.isArray(parsed)) return [];
                            const uniqueMap = new Map();
                            parsed.forEach(item => {
                                if (typeof item === 'string') {
                                    if (!uniqueMap.has(item)) uniqueMap.set(item, { name: item, organizer: '' });
                                } else if (item && item.name) {
                                    if (!uniqueMap.has(item.name)) uniqueMap.set(item.name, item);
                                }
                            });
                            return Array.from(uniqueMap.values());
                        } catch(e) { return []; }
                    }
                    return [];
                };

                onMounted(() => {
                    initPWA(); 
                    competitionItems.value = initItemsFromStorage();
                    if(!GOOGLE_SCRIPT_URL.includes("åœ¨æ­¤å¤„ç²˜è´´")) {
                        fetchAllData();
                        autoRefreshTimer = setInterval(() => { fetchAllData(true); }, 60000);
                    } else {
                        isInitializing.value = false; 
                        showDialog({title:'é…ç½®æç¤º', message:'è¯·ç¼–è¾‘ä»£ç å¡«å…¥ Web App URL', icon: 'fas fa-cog'});
                    }
                });
                
                watch(competitionItems, (newVal) => { localStorage.setItem('school_competition_items', JSON.stringify(newVal)); }, { deep: true });
                onUnmounted(() => { if (autoRefreshTimer) clearInterval(autoRefreshTimer); });

                // --- ä¸šåŠ¡é€»è¾‘ ---
                const adminAddItem = async () => {
                    const name = adminNewItemName.value.trim();
                    const organizer = adminNewItemOrg.value.trim();
                    if (!name) return showDialog({ title: 'æç¤º', message: 'æ¯”èµ›åç§°ä¸èƒ½ä¸ºç©º' });
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('addCompetition', { name, organizer });
                        adminNewItemName.value = '';
                        adminNewItemOrg.value = '';
                        await fetchAllData(); 
                        showToast('é¡¹ç›®æ·»åŠ æˆåŠŸ');
                    } catch(e) { console.error(e); }
                    isSubmitting.value = false;
                };

                const adminDeleteItem = async (name) => {
                    if (!(await showDialog({ type: 'confirm', title: 'åˆ é™¤ç¡®è®¤', message: `ç¡®å®šè¦ä»äº‘ç«¯æ°¸ä¹…åˆ é™¤â€œ${name}â€å—ï¼Ÿ`, icon: 'fas fa-trash' }))) return;
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('deleteCompetition', { name });
                        await fetchAllData();
                        showToast('é¡¹ç›®å·²åˆ é™¤');
                    } catch(e) { console.error(e); }
                    isSubmitting.value = false;
                };

                const openEditCategory = (item) => {
                    editCategoryModal.value = {
                        visible: true,
                        oldName: item.name,
                        newName: item.name,
                        organizer: item.organizer || ''
                    };
                };

                const submitEditCategory = async () => {
                    const { oldName, newName, organizer } = editCategoryModal.value;
                    if (!newName.trim()) return showDialog({ title: 'æç¤º', message: 'æ¯”èµ›åç§°ä¸èƒ½ä¸ºç©º' });
                    
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('editCompetition', { oldName, newName: newName.trim(), organizer: organizer.trim() });
                        editCategoryModal.value.visible = false;
                        if (selectedCategory.value === oldName) selectedCategory.value = newName.trim();
                        await fetchAllData();
                        showToast('æ¯”èµ›ä¿¡æ¯ä¿®æ”¹æˆåŠŸ');
                    } catch(e) {
                        console.error(e);
                        await showDialog({ type: 'alert', title: 'å¤±è´¥', message: 'ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•', icon: 'fas fa-times' });
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const submitForm = async () => {
                    let validStudents = form.value.selectedStudents.filter(s => s);
                    // ğŸ” ä¼˜åŒ–ï¼šé˜²æ­¢è€å¸ˆåœ¨å•æ¬¡æäº¤é‡Œé‡å¤é€‰æ‹©äº†åŒä¸€ä¸ªå­¦ç”Ÿ
                    validStudents = [...new Set(validStudents)];
                    
                    if (validStudents.length === 0) return showDialog({ title: 'æç¤º', message: 'è¯·è‡³å°‘é€‰æ‹©ä¸€åå­¦ç”Ÿ' });
                    
                    const currentCatStudents = dbResults.value.filter(s => s.category === form.value.category);
                    const duplicates = [];
                    validStudents = validStudents.filter(stuName => {
                        const isDup = currentCatStudents.some(s => s.studentName === stuName && s.studentClass === form.value.stuClass);
                        if (isDup) duplicates.push(stuName);
                        return !isDup;
                    });

                    if (duplicates.length > 0) {
                        await showDialog({ type: 'alert', title: 'é˜²é‡å¤æ‹¦æˆª', message: `ä»¥ä¸‹å­¦ç”Ÿå·²æŠ¥åã€${form.value.category}ã€‘ï¼Œå°†è¢«è‡ªåŠ¨å¿½ç•¥ï¼š\n\n${duplicates.join('ã€')}`, icon: 'fas fa-shield-alt' });
                    }
                    if (validStudents.length === 0) return;

                    isSubmitting.value = true;
                    let successCount = 0;
                    for (const stuName of validStudents) {
                        try {
                            await fetchAPI('register', { name: stuName, stuClass: form.value.stuClass, category: form.value.category });
                            successCount++;
                        } catch(e) { console.error(e); }
                    }
                    showToast(`æˆåŠŸæ–°å¢æŠ¥å ${successCount} äºº`);
                    
                    if (keepClassInfo.value) form.value.selectedStudents = ['', '', ''];
                    else form.value = { stuClass: '', category: '', selectedStudents: ['', '', ''] };
                    isSubmitting.value = false;
                    fetchAllData(); 
                };

                const deleteRegistration = async (stu, className) => {
                    const confirmed = await showDialog({ type: 'confirm', title: 'åˆ é™¤ç¡®è®¤', message: `ç¡®å®šè¦å–æ¶ˆã€${className} ${stu.studentName}ã€‘çš„å‚èµ›èµ„æ ¼å—ï¼Ÿ\nåˆ é™¤åä¸å¯æ¢å¤ï¼`, icon: 'fas fa-exclamation-triangle' });
                    if (!confirmed) return;

                    isSubmitting.value = true;
                    try {
                        await fetchAPI('deleteRegistration', {
                            name: stu.studentName,
                            stuClass: className,
                            category: selectedCategory.value
                        });
                        showToast(`å·²åˆ é™¤ ${stu.studentName} çš„æŠ¥åä¿¡æ¯`);
                        fetchAllData();
                    } catch (e) {
                        await showDialog({ type: 'alert', title: 'åˆ é™¤å¤±è´¥', message: e.message });
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const startBatchEdit = async () => {
                    const pwd = await showDialog({ type: 'password', title: 'ç®¡ç†å‘˜éªŒè¯', message: 'è¯·è¾“å…¥æ“ä½œå¯†ç ä»¥å¼€å§‹å½•å…¥:', placeholder: 'è¯·è¾“å…¥å¯†ç ', icon: 'fas fa-lock' });
                    if (pwd !== '888888') {
                        if (pwd !== false) await showDialog({ title: 'é”™è¯¯', message: 'å¯†ç é”™è¯¯' });
                        return;
                    }
                    const currentGroups = getSelectedGroupedByGrade();
                    batchEditData.value = JSON.parse(JSON.stringify(currentGroups));
                    isBatchEditing.value = true;
                };

                const cancelBatchEdit = () => {
                    isBatchEditing.value = false;
                    batchEditData.value = [];
                };

                const saveBatchEdit = async () => {
                    isSubmitting.value = true;
                    let changeCount = 0;
                    const updates = [];

                    batchEditData.value.forEach(group => {
                        group.classes.forEach(cls => {
                            cls.students.forEach(stu => {
                                const original = dbResults.value.find(orig => orig.studentName === stu.studentName && orig.studentClass === cls.className && orig.category === selectedCategory.value);
                                if (original) {
                                    const newScore = String(stu.score || '').trim();
                                    const newRank = String(stu.rank || '').trim();
                                    const oldScore = String(original.score || '').trim();
                                    const oldRank = String(original.rank || '').trim();

                                    if (newScore !== oldScore || newRank !== oldRank) {
                                        updates.push({ name: stu.studentName, stuClass: cls.className, category: selectedCategory.value, score: newScore, rank: newRank });
                                    }
                                }
                            });
                        });
                    });

                    if (updates.length === 0) {
                        isSubmitting.value = false;
                        isBatchEditing.value = false;
                        showToast('æœªæ£€æµ‹åˆ°ä»»ä½•ä¿®æ”¹');
                        return;
                    }

                    try {
                        for (let i = 0; i < updates.length; i++) {
                            await fetchAPI('updateScore', updates[i]);
                            changeCount++;
                        }
                        showToast(`å·²æˆåŠŸä¿å­˜ ${changeCount} æ¡æˆç»©`);
                        isBatchEditing.value = false;
                        fetchAllData(); 
                    } catch (e) {
                        console.error(e);
                        await showDialog({ title: 'éƒ¨åˆ†å¤±è´¥', message: 'ç½‘ç»œä¼ è¾“ä¸­æ–­ï¼Œè¯·åˆ·æ–°åæ£€æŸ¥æ•°æ®å®Œæ•´æ€§ã€‚', icon: 'fas fa-exclamation-triangle' });
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const openScoreModal = (stu, className) => {
                    scoreModal.value = { visible: true, studentName: stu.studentName, className: className, score: stu.score || '', rank: stu.rank || '', category: selectedCategory.value, password: '' };
                };

                const submitScore = async () => {
                    if (scoreModal.value.password !== '888888') {
                        await showDialog({ type: 'alert', title: 'å¯†ç é”™è¯¯', message: 'æ“ä½œå¯†ç ä¸æ­£ç¡®ï¼Œæ— æ³•ä¿å­˜ã€‚', icon: 'fas fa-lock' });
                        return;
                    }
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('updateScore', {
                            name: scoreModal.value.studentName,
                            stuClass: scoreModal.value.className,
                            category: scoreModal.value.category,
                            score: scoreModal.value.score,
                            rank: scoreModal.value.rank
                        });
                        scoreModal.value.visible = false;
                        const target = dbResults.value.find(s => s.studentName === scoreModal.value.studentName && s.studentClass === scoreModal.value.className && s.category === scoreModal.value.category);
                        if (target) {
                            target.score = scoreModal.value.score;
                            target.rank = scoreModal.value.rank;
                        }
                        showToast('å•æ¡æˆç»©å·²ä¿å­˜');
                    } catch(e) {
                        console.error(e);
                        await showDialog({ type: 'alert', title: 'å¤±è´¥', message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', icon: 'fas fa-times' });
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                // --- ğŸ–¨ï¸ ä¸‰åˆä¸€æŠ¥è¡¨ç”Ÿæˆæ ¸å¿ƒ ---
                const generatePrintHtml = (title, tableContent) => {
                    const categoryName = selectedCategory.value;
                    const date = new Date().toLocaleDateString();
                    const groupInfo = groupedResults.value.find(g => g.categoryName === categoryName);
                    const orgText = groupInfo && groupInfo.organizer ? `<div style="margin-bottom:5px;">ä¸»åŠå•ä½: ${groupInfo.organizer}</div>` : '';

                    // ğŸ–¨ï¸ ä¼˜åŒ–: ä½¿ç”¨æ›´å®‰å…¨çš„ ES6 æ¨¡æ¿å­—ç¬¦ä¸²æ‹¼æ¥å…³é—­è„šæœ¬æ ‡ç­¾ï¼Œé˜²æ­¢è¯­æ³•æŠ¥é”™
                    return `
                        <html><head><title>${categoryName} - ${title}</title>
                            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css" />
                            <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai&display=swap" rel="stylesheet">
                            <style>
                                body { font-family: "LXGW WenKai Screen", "LXGW WenKai", KaiTi, "æ¥·ä½“", STKaiti, "åæ–‡æ¥·ä½“", serif; padding: 30px 20px; }
                                h1 { text-align: center; margin-bottom: 5px; font-size: 26px; font-weight: bold; }
                                .subtitle { text-align: center; font-size: 14px; margin-bottom: 25px; color: #555; }
                                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 15px; }
                                th, td { border: 1px solid #333; padding: 10px 8px; text-align: center; }
                                th { background-color: #f0f0f0; font-weight: bold; }
                                .grade-header { background-color: #e0e0e0; font-weight: bold; text-align: left; padding-left: 15px; font-size: 16px; }
                                .signature { margin-top: 50px; display: flex; justify-content: space-between; padding: 0 40px; font-size: 16px; }
                            </style>
                        </head><body>
                            <h1>${categoryName} - ${title}</h1>
                            <div class="subtitle">${orgText}<div>ç”Ÿæˆæ—¥æœŸ: ${date}</div></div>
                            ${tableContent}
                            <div class="signature"><div>è£åˆ¤/è´Ÿè´£äººç­¾å: ________________</div><div>æ—¥æœŸ: ________________</div></div>
                            <script>window.onload = () => { window.print(); };${'</'}script>
                        </body></html>
                    `;
                };

                const printRoster = () => {
                    let tableContent = `<table><thead><tr><th style="width: 10%">åºå·</th><th style="width: 25%">ç­çº§</th><th style="width: 35%">å§“å</th><th style="width: 30%">å¤‡æ³¨</th></tr></thead><tbody>`;
                    getSelectedGroupedByGrade().forEach(group => {
                        tableContent += `<tr><td colspan="4" class="grade-header">${group.gradeLabel} (å…± ${group.totalStudents} äºº)</td></tr>`;
                        let index = 1;
                        group.classes.forEach(cls => {
                            cls.students.forEach(stu => {
                                tableContent += `<tr><td>${index++}</td><td>${cls.className}</td><td>${stu.studentName}</td><td></td></tr>`;
                            });
                        });
                    });
                    tableContent += `</tbody></table>`;
                    const win = window.open('', '_blank');
                    win.document.write(generatePrintHtml('å‚èµ›ç‚¹åè¡¨', tableContent));
                    win.document.close();
                };

                const printScoringSheet = () => {
                    let tableContent = `<table><thead><tr><th style="width: 8%">åºå·</th><th style="width: 15%">ç­çº§</th><th style="width: 27%">å§“å</th><th style="width: 15%">åˆ†æ•°</th><th style="width: 15%">åæ¬¡</th><th style="width: 20%">å¤‡æ³¨</th></tr></thead><tbody>`;
                    getSelectedGroupedByGrade().forEach(group => {
                        tableContent += `<tr><td colspan="6" class="grade-header">${group.gradeLabel} (å…± ${group.totalStudents} äºº)</td></tr>`;
                        let index = 1;
                        group.classes.forEach(cls => {
                            cls.students.forEach(stu => {
                                tableContent += `<tr><td>${index++}</td><td>${cls.className}</td><td>${stu.studentName}</td><td>${stu.score || ''}</td><td>${stu.rank || ''}</td><td></td></tr>`;
                            });
                        });
                    });
                    tableContent += `</tbody></table>`;
                    const win = window.open('', '_blank');
                    win.document.write(generatePrintHtml('è¯„åˆ†è®°å½•è¡¨', tableContent));
                    win.document.close();
                };

                const printResults = () => {
                    let tableContent = `<table><thead><tr><th style="width: 20%">åæ¬¡</th><th style="width: 25%">ç­çº§</th><th style="width: 35%">å§“å</th><th style="width: 20%">åˆ†æ•°</th></tr></thead><tbody>`;
                    let hasWinners = false;

                    getSelectedGroupedByGrade().forEach(group => {
                        const winners = [];
                        group.classes.forEach(cls => {
                            cls.students.forEach(stu => {
                                if(stu.rank) winners.push({...stu, className: cls.className});
                            });
                        });
                        
                        if(winners.length > 0) {
                            hasWinners = true;
                            tableContent += `<tr><td colspan="4" class="grade-header">${group.gradeLabel}</td></tr>`;
                            winners.sort((a,b) => {
                                const diff = getRankWeight(b.rank) - getRankWeight(a.rank);
                                if (diff !== 0) return diff;
                                return (parseFloat(b.score) || 0) - (parseFloat(a.score) || 0);
                            });
                            
                            winners.forEach(stu => {
                                tableContent += `<tr><td style="font-weight:bold; font-size:16px;">${stu.rank}</td><td>${stu.className}</td><td style="font-weight:bold;">${stu.studentName}</td><td>${stu.score || '-'}</td></tr>`;
                            });
                        }
                    });
                    
                    if(!hasWinners) {
                        tableContent += `<tr><td colspan="4" style="color:#999; padding:20px;">è¯¥é¡¹ç›®æš‚æ— å¾—å¥–è®°å½•</td></tr>`;
                    }
                    tableContent += `</tbody></table>`;
                    
                    const win = window.open('', '_blank');
                    win.document.write(generatePrintHtml('å®˜æ–¹å¾—å¥–åå•', tableContent));
                    win.document.close();
                };

                // ğŸ“Š ä¼˜åŒ–ï¼šå¯¼å‡º CSV æ ¼å¼å¢å¼ºï¼Œä½¿ç”¨åŒå¼•å·åŒ…è£¹é˜²æ­¢åå­—é‡Œå¸¦æœ‰é€—å·å¯¼è‡´è¡¨æ ¼é”™ä½
                const exportCSV = () => {
                    const groupData = getSelectedGroupedByGrade();
                    const categoryName = selectedCategory.value;
                    let csvContent = "\uFEFF"; 
                    csvContent += `"æ¯”èµ›é¡¹ç›®ï¼š${categoryName}"\n`;
                    csvContent += `"å¹´çº§","ç­çº§","å§“å","åˆ†æ•°","åæ¬¡"\n`;

                    groupData.forEach(group => {
                        group.classes.forEach(cls => {
                            cls.students.forEach(stu => {
                                csvContent += `"${group.gradeLabel}","${cls.className}","${stu.studentName}","${stu.score || ''}","${stu.rank || ''}"\n`;
                            });
                        });
                    });

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `${categoryName}_å‚èµ›æˆç»©åå•.csv`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('Excelå·²å¯¼å‡ºä¸‹è½½');
                };

                const showDialog = (opts) => new Promise(resolve => {
                    modalState.value = { visible: true, type: opts.type || 'alert', title: opts.title || 'æç¤º', message: opts.message || '', placeholder: opts.placeholder || '', icon: opts.icon || 'fas fa-info-circle', resolve };
                    if(['prompt','password'].includes(opts.type)) nextTick(() => modalInput.value?.focus());
                });
                const handleModalConfirm = () => {
                    const val = modalState.value.type === 'confirm' ? true : modalState.value.inputValue;
                    modalState.value.resolve(val);
                    modalState.value.visible = false;
                };
                const handleModalCancel = () => {
                    modalState.value.resolve(false);
                    modalState.value.visible = false;
                };
                
                const enterAdmin = async () => {
                    if (isAdmin.value) {
                        currentTab.value = 'admin';
                        selectedCategory.value = null;
                        return;
                    }
                    const pwd = await showDialog({ type: 'password', title: 'åå°ç®¡ç†', message: 'è¾“å…¥ç®¡ç†å‘˜å¯†ç :', placeholder: 'è¯·è¾“å…¥å¯†ç ', icon: 'fas fa-lock' });
                    if (pwd === "123456") {
                        isAdmin.value = true;
                        const choice = await showDialog({ type: 'confirm', title: 'ç™»å½•æˆåŠŸ', message: 'è¦å»é¡¹ç›®ç®¡ç†åå°å—ï¼Ÿ\n(å–æ¶ˆåˆ™ç•™åœ¨å¤§å…è¿›è¡Œæˆç»©å½•å…¥)', icon: 'fas fa-user-shield' });
                        if (choice) {
                            currentTab.value = 'admin';
                            selectedCategory.value = null;
                        }
                    }
                    else if (pwd !== false) showDialog({ title: 'é”™è¯¯', message: 'å¯†ç é”™è¯¯' });
                };

                const getRankWeight = (rank) => {
                    if (!rank) return 0;
                    if (rank.includes('å† ')) return 10000;
                    if (rank.includes('äºš')) return 9000;
                    if (rank.includes('å­£')) return 8000;
                    if (rank.includes('å››')) return 7000;
                    if (rank.includes('äº”')) return 6000;
                    if (rank.includes('ç‰¹ä¼˜')) return 5000;
                    if (rank.includes('ä¼˜ç§€')) return 4000;
                    if (rank.includes('å®‰æ…°')) return 3000;
                    return 1000;
                };

                const groupedResults = computed(() => {
                    let filtered = dbResults.value;
                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        filtered = filtered.filter(i => JSON.stringify(i).toLowerCase().includes(q));
                    }
                    return competitionItems.value.map(catObj => {
                        const catName = typeof catObj === 'string' ? catObj : (catObj?.name || '');
                        if (!catName) return null;

                        const students = filtered.filter(d => d.category && d.category.trim() === catName.trim());
                        if (searchQuery.value && students.length === 0) return null;
                        
                        students.sort((a, b) => {
                            const rankA = getRankWeight(a.rank);
                            const rankB = getRankWeight(b.rank);
                            if (rankA !== rankB) return rankB - rankA; 
                            const scoreA = parseFloat(a.score) || 0;
                            const scoreB = parseFloat(b.score) || 0;
                            if (scoreA !== scoreB) return scoreB - scoreA; 
                            return 0;
                        });

                        const classMap = {};
                        students.forEach(s => {
                            const c = s.studentClass || 'æœªåˆ†ç±»';
                            if (!classMap[c]) classMap[c] = [];
                            classMap[c].push(s);
                        });
                        
                        return {
                            categoryName: catName,
                            organizer: typeof catObj === 'object' ? (catObj.organizer || '') : '',
                            totalCount: students.length,
                            classes: Object.keys(classMap).sort().map(c => ({ className: c, students: classMap[c] }))
                        };
                    }).filter(i => i !== null);
                });

                const getSelectedGroupCount = () => groupedResults.value.find(g => g.categoryName === selectedCategory.value)?.totalCount || 0;
                const getSelectedGroupOrganizer = () => groupedResults.value.find(g => g.categoryName === selectedCategory.value)?.organizer || '';
                
                const getSelectedGroupedByGrade = () => {
                    const group = groupedResults.value.find(g => g.categoryName === selectedCategory.value);
                    if (!group) return [];

                    const gradesMap = {};
                    group.classes.forEach(cls => {
                        const gradeChar = cls.className.charAt(0);
                        if (!gradesMap[gradeChar]) gradesMap[gradeChar] = [];
                        gradesMap[gradeChar].push(cls);
                    });

                    const gradeNames = {'1':'ä¸€å¹´çº§', '2':'äºŒå¹´çº§', '3':'ä¸‰å¹´çº§', '4':'å››å¹´çº§', '5':'äº”å¹´çº§', '6':'å…­å¹´çº§'};

                    return Object.keys(gradesMap).sort().map(g => {
                        const classesInGrade = gradesMap[g];
                        const totalStudents = classesInGrade.reduce((sum, cls) => sum + cls.students.length, 0);
                        return {
                            gradeLabel: gradeNames[g] || (g + 'å¹´çº§'),
                            totalStudents: totalStudents,
                            classes: classesInGrade 
                        };
                    });
                };

                const exitCategory = () => {
                    if (isBatchEditing.value) {
                        if(!confirm("æ‚¨æ­£åœ¨å½•å…¥æ¨¡å¼ï¼Œé€€å‡ºå°†ä¸¢å¤±æœªä¿å­˜çš„æ›´æ”¹ã€‚ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ")) return;
                        isBatchEditing.value = false;
                    }
                    selectedCategory.value = null;
                };

                const getCategoryIcon = (n) => {
                    if (!n) return 'fas fa-trophy';
                    if(n.includes('å‰ªçº¸')) return 'fas fa-cut';
                    if(n.includes('æŒ¥æ˜¥')) return 'fas fa-paint-brush';
                    if(n.includes('åè¯­')||n.includes('æ•…äº‹')) return 'fas fa-book-open';
                    if(n.includes('è‹±')||n.includes('æœ—è¯»')) return 'fas fa-language';
                    if(n.includes('ä¹¦')||n.includes('ç¬”')) return 'fas fa-pen-nib';
                    if(n.includes('ç”»')||n.includes('ç¾')) return 'fas fa-palette';
                    if(n.includes('ç®—')||n.includes('æ•°')||n.includes('æœº')) return 'fas fa-calculator';
                    if(n.includes('æ­Œ')||n.includes('å”±')||n.includes('èˆ')) return 'fas fa-microphone-alt';
                    if(n.includes('è·‘')||n.includes('çƒ')||n.includes('ä½“')) return 'fas fa-running';
                    return 'fas fa-trophy';
                };
                
                const getRankClass = (rank) => {
                    if (!rank) return '';
                    if (rank.includes('å† ')) return 'bg-yellow-100 text-yellow-700 border border-yellow-200';
                    if (rank.includes('äºš')) return 'bg-gray-200 text-gray-700 border border-gray-300';
                    if (rank.includes('å­£')) return 'bg-orange-100 text-orange-700 border border-orange-200';
                    if (rank.includes('å››')) return 'bg-teal-100 text-teal-700 border border-teal-200';
                    if (rank.includes('äº”')) return 'bg-indigo-100 text-indigo-700 border border-indigo-200';
                    if (rank.includes('ç‰¹ä¼˜')) return 'bg-purple-100 text-purple-700 border border-purple-200';
                    return 'bg-blue-50 text-blue-600 border border-blue-100';
                };

                return {
                    currentTab, selectedCategory, isInitializing, isRefreshing, isSubmitting, initStatus, isAdmin, isBatchEditing,
                    competitionItems, availableClasses: computed(() => classList.value), availableStudents: computed(() => studentDB.value[form.value.stuClass] || []),
                    form, searchQuery, keepClassInfo, adminNewItemName, adminNewItemOrg, batchEditData,
                    goHome: () => { currentTab.value = 'results'; selectedCategory.value = null; isBatchEditing.value = false; },
                    goToRegister: (cat) => { currentTab.value = 'register'; form.value.category = cat; },
                    exitCategory,
                    groupedResults, getSelectedGroupCount, getSelectedGroupOrganizer, getSelectedGroupedByGrade, getCategoryIcon, getRankClass,
                    modalState, handleModalConfirm, handleModalCancel, modalInput, toastState,
                    scoreModal, openScoreModal, submitScore, 
                    printRoster, printScoringSheet, printResults, exportCSV, 
                    deleteRegistration, startBatchEdit, cancelBatchEdit, saveBatchEdit,
                    editCategoryModal, openEditCategory, submitEditCategory,
                    enterAdmin, adminAddItem, adminDeleteItem, submitForm, fetchAllData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
