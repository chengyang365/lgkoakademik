<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>新廊华小校内竞赛系统</title>
    
    <!-- PWA 配置支持 -->
    <meta name="theme-color" content="#f97316">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="校内竞赛">
    <link rel="icon" type="image/png" sizes="32x32" href="https://em-content.zobj.net/source/apple/419/trophy_1f3c6.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://em-content.zobj.net/source/apple/419/trophy_1f3c6.png">
    <link rel="apple-touch-icon" href="https://em-content.zobj.net/source/apple/419/trophy_1f3c6.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai&display=swap" rel="stylesheet">
    
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95); }
        
        body, button, input, select, textarea { 
            font-family: "LXGW WenKai Screen", "LXGW WenKai", KaiTi, "楷体", STKaiti, "华文楷体", serif !important; 
        }
        
        /* 海报专用样式 */
        .poster-container {
            background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%);
            color: #fff;
            font-family: "LXGW WenKai", serif;
        }
        .poster-card {
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            #app { min-height: auto; }
        }
    </style>
</head>
<body class="bg-yellow-50 text-gray-800">

    <div id="app" class="min-h-screen flex flex-col">
        
        <!-- Navbar -->
        <nav class="bg-orange-500 text-white shadow-lg sticky top-0 z-40 no-print">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div @click="goHome" class="flex items-center space-x-2 cursor-pointer group">
                    <i class="fas fa-shapes text-yellow-200 text-2xl group-hover:scale-110 transition"></i>
                    <div>
                        <h1 class="text-lg font-bold leading-tight">{{ t('school_name') }}</h1>
                        <p class="text-xs text-orange-100 opacity-90">{{ t('system_subtitle') }}</p>
                    </div>
                </div>
                <div class="flex space-x-2 text-sm font-bold">
                    <button @click="goHome" :class="{'bg-white text-orange-600 shadow-md': currentTab === 'results'}" class="px-3 py-2 rounded-lg transition duration-200 flex items-center hover:bg-orange-400 hidden sm:flex">
                        <i class="fas fa-home mr-1"></i> {{ t('nav_lobby') }}
                    </button>
                    <button @click="enterAdmin" :class="{'bg-gray-800 text-yellow-400 shadow-md': currentTab === 'admin' || isAdmin}" class="px-3 py-2 rounded-lg transition duration-200 flex items-center border border-orange-400 hover:bg-orange-600">
                        <i class="fas" :class="isAdmin ? 'fa-user-shield' : 'fa-cogs'"></i> <span class="ml-1">{{ isAdmin ? '管理员' : '管理' }}</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Toast -->
        <transition name="fade">
            <div v-if="toastState.visible" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-[150] px-6 py-3 rounded-full shadow-lg font-bold text-sm flex items-center transition-all duration-300"
                 :class="toastState.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'">
                <i :class="toastState.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'" class="mr-2"></i>
                {{ toastState.message }}
            </div>
        </transition>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-6 max-w-5xl">

            <!-- 全局加载状态 -->
            <div v-if="isInitializing" class="fixed inset-0 bg-yellow-50 z-50 flex flex-col items-center justify-center no-print">
                <div class="loader w-12 h-12 border-4 border-orange-200 border-t-orange-500 mb-4"></div>
                <p class="text-orange-600 font-bold animate-pulse">正在连接云端数据库...</p>
            </div>

            <!-- TAB 1: 比赛大厅 -->
            <transition name="fade" mode="out-in">
                <div v-if="currentTab === 'results'" key="results" class="space-y-6">
                    <!-- 工具栏 -->
                    <div class="flex flex-row gap-3 items-center justify-between no-print">
                        <h2 v-if="!selectedCategory" class="text-xl font-bold text-gray-700 hidden sm:block">
                            <i class="fas fa-bullhorn text-orange-500 mr-2"></i>{{ t('lobby_title') }}
                        </h2>
                        <div class="flex-grow flex gap-2 justify-end items-center">
                             
                             <!-- 状态指示器 -->
                             <div class="flex items-center text-xs px-2 py-1 rounded-full border shadow-sm hidden sm:flex font-bold"
                                  :class="isOfflineMode ? 'bg-red-50 text-red-500 border-red-200' : 'bg-white text-orange-400/80 border-orange-100'">
                                <span class="relative flex h-2 w-2 mr-2">
                                  <span v-if="!isOfflineMode" :class="isInitializing ? 'bg-gray-300' : 'bg-green-400 animate-ping'" class="absolute inline-flex h-full w-full rounded-full opacity-75"></span>
                                  <span :class="isOfflineMode ? 'bg-red-500' : (isInitializing ? 'bg-gray-400' : 'bg-green-500')" class="relative inline-flex rounded-full h-2 w-2"></span>
                                </span>
                                {{ isOfflineMode ? t('status_offline') : (isInitializing ? t('status_connecting') : t('status_live')) }}
                            </div>
                            
                            <!-- 多语言切换 -->
                            <div class="relative group mr-2">
                                <button class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-lg flex items-center transition border border-gray-300 font-bold">
                                    {{ currentLangLabel }}
                                </button>
                                <div class="absolute right-0 mt-1 w-24 bg-white rounded-lg shadow-xl border border-gray-100 hidden group-hover:block z-50 text-gray-700 overflow-hidden">
                                    <button @click="setLang('zh')" class="w-full text-left px-4 py-2 hover:bg-orange-50 hover:text-orange-600 text-sm">中文</button>
                                    <button @click="setLang('ms')" class="w-full text-left px-4 py-2 hover:bg-orange-50 hover:text-orange-600 text-sm">BM</button>
                                    <button @click="setLang('en')" class="w-full text-left px-4 py-2 hover:bg-orange-50 hover:text-orange-600 text-sm">EN</button>
                                </div>
                            </div>

                             <div class="relative w-full max-w-xs sm:max-w-md">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input v-model="searchQuery" type="text" :placeholder="t('search_placeholder')" 
                                    class="w-full border border-orange-200 rounded-full pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300 transition bg-white shadow-sm">
                            </div>
                            <button @click="fetchAllData(false)" class="bg-white text-orange-600 px-3 py-2 rounded-full shadow-sm border border-orange-100 hover:bg-orange-50 transition font-bold text-sm whitespace-nowrap" title="立即刷新">
                                <i class="fas fa-sync-alt" :class="{'fa-spin': isRefreshing}"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 管理员提示条 -->
                    <div v-if="isAdmin" class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded-r shadow-sm flex justify-between items-center text-sm no-print">
                        <span class="text-blue-700"><i class="fas fa-info-circle mr-1"></i> {{ t('admin_mode_hint') }}</span>
                        <button @click="isAdmin=false; isBatchEditing=false; currentTab='results'" class="text-blue-400 hover:text-blue-600 underline text-xs">{{ t('btn_exit_admin') }}</button>
                    </div>

                    <!-- 视图 A: 比赛项目列表 (进行中) -->
                    <div v-if="!selectedCategory">
                        <div v-if="isInitializing" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 animate-pulse">
                            <div v-for="n in 3" :key="n" class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 flex flex-col items-center text-center h-48"><div class="w-16 h-16 rounded-full bg-gray-200 mb-4"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div></div>
                        </div>

                        <!-- 真正的数据列表 (进行中) -->
                        <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div v-for="group in visibleOngoingGroups" :key="group.categoryName" 
                                 @click="selectedCategory = group.categoryName"
                                 class="bg-white rounded-2xl shadow-md border-2 border-transparent hover:border-orange-400 hover:shadow-xl transition cursor-pointer p-6 flex flex-col items-center text-center group h-full transform hover:-translate-y-1 relative overflow-hidden">
                                
                                <div class="w-16 h-16 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-3xl mb-4 shadow-inner">
                                    <i :class="getCategoryIcon(group.categoryName)"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 mb-1">{{ group.categoryName }}</h3>
                                <!-- 显示日期范围 -->
                                <div v-if="group.startDate || group.endDate" class="text-xs text-gray-400 mb-2">
                                    <i class="far fa-calendar-alt mr-1"></i>{{ formatDate(group.startDate) }} <span v-if="group.endDate">- {{ formatDate(group.endDate) }}</span>
                                </div>
                                
                                <div class="mt-auto w-full pt-2 border-t border-gray-50">
                                    <span class="text-xs font-bold px-2 py-0.5 rounded-full shadow-sm bg-green-500 text-white">
                                        {{ t('label_ongoing') }}
                                    </span>
                                    <div class="text-gray-500 text-sm mt-2">{{ t('label_registered') }}: <span class="text-xl font-bold text-orange-600">{{ group.totalCount }}</span> {{ t('unit_person') }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 暂无进行中的比赛 -->
                        <div v-if="!isInitializing && visibleOngoingGroups.length === 0 && !isAdmin" class="col-span-full text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-300">
                             <p class="text-gray-500 mb-4">{{ t('msg_no_competitions') }}</p>
                        </div>

                        <!-- 管理员可见：已结束/已截止的比赛 (显示在下方) -->
                        <div v-if="isAdmin && visibleEndedGroups.length > 0" class="mt-12 mb-6">
                            <div class="flex items-center my-6">
                                <div class="h-px bg-gray-300 flex-grow"></div>
                                <span class="mx-4 text-gray-400 font-bold text-sm uppercase"><i class="fas fa-history mr-2"></i>{{ t('status_ended') }} / {{ t('status_auto_ended') }}</span>
                                <div class="h-px bg-gray-300 flex-grow"></div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 opacity-75 grayscale hover:grayscale-0 transition duration-300">
                                <div v-for="group in visibleEndedGroups" :key="group.categoryName" 
                                     @click="selectedCategory = group.categoryName"
                                     class="bg-gray-50 rounded-2xl shadow-sm border-2 border-gray-200 hover:border-gray-400 transition cursor-pointer p-6 flex flex-col items-center text-center group h-full relative overflow-hidden">
                                    
                                    <!-- 状态角标 -->
                                    <div class="absolute top-0 right-0 bg-gray-500 text-white text-xs px-2 py-1 rounded-bl-lg font-bold z-10">
                                        {{ group.effectiveStatus === 'auto_closed' ? t('status_auto_ended') : t('status_ended') }}
                                    </div>

                                    <div class="w-16 h-16 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-3xl mb-4">
                                        <i :class="getCategoryIcon(group.categoryName)"></i>
                                    </div>
                                    <h3 class="text-lg font-bold text-gray-600 mb-1">{{ group.categoryName }}</h3>
                                    
                                    <div class="mt-auto w-full pt-2 border-t border-gray-200">
                                        <div class="text-gray-500 text-sm mt-2">{{ t('label_registered') }}: {{ group.totalCount }} {{ t('unit_person') }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 只有管理员且没有任何项目时才显示 -->
                        <div v-if="groupedResults.length === 0 && isAdmin" class="col-span-full text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-300 mt-6">
                            <p class="text-gray-500 mb-4">{{ t('msg_no_competitions') }}</p>
                            <button @click="enterAdmin" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm">{{ t('btn_goto_add') }}</button>
                        </div>
                    </div>

                    <!-- 视图 B: 项目详情页 -->
                    <div v-else class="space-y-6">
                        <div class="flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-orange-100 sticky top-16 z-30 no-print">
                            <div class="flex items-center">
                                <button @click="exitCategory" class="text-gray-600 hover:text-orange-600 font-bold flex items-center bg-gray-100 px-3 py-1.5 rounded-lg text-sm mr-3">
                                    <i class="fas fa-arrow-left mr-2"></i> {{ t('btn_back') }}
                                </button>
                                <div>
                                    <h2 class="text-lg font-bold text-gray-800">{{ selectedCategory }}</h2>
                                    <div class="flex flex-col gap-1 mt-1">
                                        <div class="flex items-center gap-2">
                                            <span v-if="getSelectedGroupOrganizer()" class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">
                                                <i class="fas fa-building mr-1"></i> {{ t('label_organizer') }}: {{ getSelectedGroupOrganizer() }}
                                            </span>
                                            <span v-if="isBatchEditing" class="text-xs text-red-500 font-bold animate-pulse">● {{ t('mode_entry') }}</span>
                                        </div>
                                        <div v-if="getSelectedGroupDateRange()" class="text-xs text-gray-400">
                                            <i class="far fa-clock mr-1"></i> {{ getSelectedGroupDateRange() }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="!isBatchEditing" class="text-sm bg-orange-100 text-orange-700 px-3 py-1 rounded-full font-bold">{{ getSelectedGroupCount() }} {{ t('unit_person') }}</div>
                        </div>

                        <!-- 详情页数据列表 -->
                        <div v-if="getSelectedGroupCount() > 0">
                            <!-- 操作按钮组 -->
                            <div v-if="!isBatchEditing" class="mb-6 flex flex-wrap justify-end gap-3 no-print">
                                <button v-if="isAdmin" @click="startBatchEdit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow text-sm flex items-center transition animate-bounce-once">
                                    <i class="fas fa-pencil-alt mr-2"></i> {{ t('btn_batch_entry') }}
                                </button>
                                
                                <!-- 生成海报按钮 -->
                                <button v-if="isAdmin" @click="openPosterModal()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold shadow-sm text-sm flex items-center transition">
                                    <i class="fas fa-image mr-2"></i> {{ t('btn_poster') }}
                                </button>

                                <!-- 打印功能下拉菜单 -->
                                <div class="relative group inline-block">
                                    <button class="bg-white border border-gray-300 text-gray-700 group-hover:bg-gray-50 px-4 py-2 rounded-lg font-bold shadow-sm text-sm flex items-center transition h-full">
                                        <i class="fas fa-print mr-2"></i> {{ t('btn_print_options') }} <i class="fas fa-chevron-down ml-2 text-xs"></i>
                                    </button>
                                    <div class="absolute right-0 mt-1 w-44 bg-white rounded-xl shadow-xl border border-gray-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 overflow-hidden">
                                        <button @click="printRoster" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition flex items-center border-b border-gray-50">
                                            <i class="fas fa-list-ol w-5 text-center mr-2 text-blue-500"></i> {{ t('print_roster') }}
                                        </button>
                                        <button @click="printScoringSheet" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition flex items-center border-b border-gray-50">
                                            <i class="fas fa-clipboard-check w-5 text-center mr-2 text-orange-500"></i> {{ t('print_score_sheet') }}
                                        </button>
                                        <button @click="printResults" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-yellow-50 hover:text-yellow-600 transition flex items-center">
                                            <i class="fas fa-trophy w-5 text-center mr-2 text-yellow-500"></i> {{ t('print_winners') }}
                                        </button>
                                    </div>
                                </div>

                                <button @click="goToRegister(selectedCategory)" :disabled="getCategoryStatus(selectedCategory) !== 'open'" :class="getCategoryStatus(selectedCategory) !== 'open' ? 'bg-gray-400 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600'" class="text-white px-4 py-2 rounded-lg font-bold shadow text-sm flex items-center transition">
                                    <i class="fas fa-plus-circle mr-2"></i> {{ t('btn_add_reg') }}
                                </button>
                            </div>
                            
                            <div v-if="isBatchEditing" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg p-4 z-50 flex justify-between items-center no-print">
                                <div class="text-sm text-gray-600">
                                    <span v-if="isSubmitting"><i class="fas fa-spinner fa-spin mr-2"></i> {{ t('status_saving') }}</span>
                                    <span v-else>{{ t('hint_batch_mode') }}</span>
                                </div>
                                <div class="flex gap-3">
                                    <button @click="cancelBatchEdit" :disabled="isSubmitting" class="px-6 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg font-bold">{{ t('btn_cancel') }}</button>
                                    <button @click="saveBatchEdit" :disabled="isSubmitting" class="px-6 py-2 bg-green-600 text-white hover:bg-green-700 rounded-lg font-bold shadow-lg transform active:scale-95 transition">
                                        <i class="fas fa-save mr-2"></i> {{ t('btn_save_all') }}
                                    </button>
                                </div>
                            </div>

                            <!-- 按年级分组循环 -->
                            <div v-for="(gradeGroup, gIndex) in (isBatchEditing ? batchEditData : getSelectedGroupedByGrade())" :key="gIndex" class="mb-8 break-inside-avoid">
                                <div class="flex items-center mb-4">
                                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold text-sm shadow-sm border border-blue-200">
                                        {{ gradeGroup.translatedLabel }} ({{ t('total') }} {{ gradeGroup.totalStudents }} {{ t('unit_person') }})
                                    </span>
                                    <div class="h-px bg-blue-100 flex-grow ml-4 no-print"></div>
                                </div>

                                <div v-if="!isBatchEditing" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div v-for="cls in gradeGroup.classes" :key="cls.className" class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm relative overflow-hidden break-inside-avoid">
                                        <div class="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                                            <span class="font-bold text-blue-600 text-lg">{{ cls.className }}</span>
                                            <span class="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-bold">{{ cls.students.length }}{{ t('unit_person') }}</span>
                                        </div>
                                        <ul class="space-y-2">
                                            <li v-for="stu in cls.students" :key="stu.rowIndex" class="flex justify-between items-center text-sm p-2 rounded hover:bg-gray-50 transition group">
                                                <span class="font-medium text-gray-700 flex items-center">{{ stu.studentName }}</span>
                                                <div class="flex items-center gap-1">
                                                    <span v-if="stu.rank" :class="getRankClass(stu.rank)" class="text-xs px-2 py-0.5 rounded font-bold scale-90 whitespace-nowrap">{{ t_rank(stu.rank) }}</span>
                                                    <span v-else-if="stu.score" class="text-gray-500 font-mono text-xs bg-gray-100 px-1 rounded">{{ stu.score }}分</span>
                                                    <button v-if="isAdmin" @click.stop="deleteRegistration(stu, cls.className)" class="text-gray-300 hover:text-red-500 p-1 transition opacity-0 group-hover:opacity-100 no-print"><i class="fas fa-trash-alt"></i></button>
                                                    <button v-if="isAdmin" @click.stop="openScoreModal(stu, cls.className)" class="text-gray-300 hover:text-blue-500 p-1 transition opacity-0 group-hover:opacity-100 no-print"><i class="fas fa-pencil-alt"></i></button>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <div v-else class="bg-white rounded-xl border border-blue-200 shadow-sm overflow-hidden">
                                    <table class="w-full text-left border-collapse">
                                        <thead class="bg-blue-50 text-blue-800 text-xs uppercase">
                                            <tr>
                                                <th class="p-3 border-b border-blue-100">{{ t('th_class') }}</th>
                                                <th class="p-3 border-b border-blue-100">{{ t('th_name') }}</th>
                                                <th class="p-3 border-b border-blue-100 w-24">{{ t('th_score') }}</th>
                                                <th class="p-3 border-b border-blue-100 w-32">{{ t('th_rank') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100">
                                            <template v-for="cls in gradeGroup.classes" :key="cls.className">
                                                <tr v-for="stu in cls.students" :key="stu.rowIndex" class="hover:bg-yellow-50 transition">
                                                    <td class="p-3 font-mono text-gray-500 text-sm">{{ cls.className }}</td>
                                                    <td class="p-3 font-medium text-gray-800">{{ stu.studentName }}</td>
                                                    <td class="p-2"><input type="text" v-model="stu.score" class="w-full border border-gray-300 rounded px-2 py-1 text-sm text-center outline-none focus:ring-2 focus:ring-blue-500" placeholder="-"></td>
                                                    <td class="p-2">
                                                        <select v-model="stu.rank" class="w-full border border-gray-300 rounded px-2 py-1 text-sm bg-white outline-none focus:ring-2 focus:ring-blue-500">
                                                            <option value="">-</option>
                                                            <option v-for="r in rankOptions" :key="r" :value="r">{{ t_rank(r) }}</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div v-if="isBatchEditing" class="h-20"></div>
                        </div>
                        
                        <div v-if="getSelectedGroupCount() === 0" class="text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-200 no-print">
                            <p class="text-gray-500 mb-4">{{ t('msg_no_records') }}</p>
                            <button @click="goToRegister(selectedCategory)" :disabled="getCategoryStatus(selectedCategory) !== 'open'" :class="getCategoryStatus(selectedCategory) !== 'open' ? 'bg-gray-400 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600'" class="text-white px-6 py-2 rounded-full font-bold shadow">{{ t('btn_go_register') }}</button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- TAB 2: 报名页面 -->
            <transition name="fade" mode="out-in">
                <div v-if="currentTab === 'register'" key="register" class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-6 border-t-4 border-orange-400 no-print">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-start">
                            <div class="bg-orange-100 p-3 rounded-full mr-4"><i class="fas fa-user-edit text-orange-500 text-xl"></i></div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">{{ t('reg_title') }}</h2>
                                <p class="text-gray-500 text-sm">{{ t('reg_subtitle') }}</p>
                            </div>
                        </div>
                        <button @click="goHome" class="text-gray-400 hover:text-gray-600 text-sm underline">{{ t('btn_cancel') }}</button>
                    </div>

                    <form @submit.prevent="submitForm" class="space-y-6">
                        <!-- Project Selection -->
                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                            <label class="block text-sm font-bold text-gray-700 mb-2">{{ t('label_item') }}</label>
                            <select v-model="form.category" required class="w-full rounded-lg border-2 border-yellow-300 p-3 outline-none bg-white font-medium text-gray-800">
                                <option value="" disabled>{{ t('ph_select_item') }}</option>
                                <option v-for="item in activeCompetitions" :key="item.name" :value="item.name">{{ item.name }}</option>
                            </select>
                            <p v-if="activeCompetitions.length === 0" class="text-xs text-red-500 mt-2">* {{ t('msg_no_competitions') }}</p>
                        </div>

                        <!-- Class Groups -->
                        <div v-for="(group, gIndex) in form.groups" :key="group.id" class="bg-blue-50 p-4 rounded-xl border border-blue-100 relative">
                             <!-- Remove Class Group Button -->
                            <button v-if="form.groups.length > 1" type="button" @click="removeClassGroup(gIndex)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 text-sm" :title="t('btn_remove_class')">
                                <i class="fas fa-times"></i>
                            </button>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-sm font-bold text-blue-800 mb-2">{{ t('label_class') }}</label>
                                    <select v-model="group.class" required class="w-full rounded-lg border-2 border-blue-200 p-3 outline-none bg-white font-mono text-lg">
                                        <option value="" disabled>{{ t('ph_select_class') }}</option>
                                        <option v-for="cls in availableClasses" :key="cls" :value="cls">{{ cls }}</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-green-800 mb-2">{{ t('label_students') }}</label>
                                    <div v-if="!group.class" class="text-gray-400 text-sm py-4 text-center border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">← {{ t('hint_select_class_first') }}</div>
                                    <div v-else class="space-y-3">
                                        <div v-for="(stu, sIndex) in group.students" :key="sIndex" class="flex gap-2">
                                            <div class="relative flex-grow">
                                                <span class="absolute left-3 top-3 text-xs font-bold text-gray-400">{{ sIndex + 1 }}.</span>
                                                <select v-model="group.students[sIndex]" class="w-full rounded-lg border border-green-200 pl-8 p-2 bg-white outline-none focus:border-green-500">
                                                    <option value="">{{ t('opt_empty') }}</option>
                                                    <option v-for="stuName in getStudentsByClass(group.class)" :key="stuName" :value="stuName">{{ stuName }}</option>
                                                </select>
                                            </div>
                                             <!-- Remove Student Row Button -->
                                            <button v-if="group.students.length > 1" type="button" @click="removeStudentRow(gIndex, sIndex)" class="text-gray-300 hover:text-red-500 px-1">
                                                <i class="fas fa-minus-circle"></i>
                                            </button>
                                        </div>
                                        <div class="text-right">
                                            <button type="button" @click="addStudentRow(gIndex)" class="text-xs text-blue-500 hover:text-blue-700 font-bold">
                                                <i class="fas fa-plus mr-1"></i> {{ t('btn_add_student') }}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                         <!-- Add Class Group Button -->
                        <div class="text-center">
                            <button type="button" @click="addClassGroup" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg font-bold text-sm border border-gray-300 shadow-sm transition">
                                <i class="fas fa-layer-group mr-1"></i> {{ t('btn_add_class') }}
                            </button>
                        </div>
                        
                         <div class="mt-4 flex items-center justify-end text-xs text-gray-500">
                            <label class="flex items-center"><input type="checkbox" v-model="keepClassInfo" class="mr-1"> {{ t('chk_keep_class') }}</label>
                        </div>

                        <button type="submit" :disabled="isSubmitting" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform active:scale-95 transition disabled:opacity-60 disabled:cursor-not-allowed">
                            <span v-if="isSubmitting" class="loader inline-block mr-2 w-4 h-4 border-2 border-white border-t-transparent"></span>
                            {{ isSubmitting ? t('btn_submitting') : t('btn_submit_reg') }}
                        </button>
                    </form>
                </div>
            </transition>

            <!-- TAB 3: 管理后台 -->
            <transition name="fade" mode="out-in">
                <div v-if="currentTab === 'admin'" key="admin" class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200 no-print">
                    <div class="bg-gray-800 text-white p-6 flex justify-between items-center">
                        <h2 class="text-xl font-bold"><i class="fas fa-cogs text-yellow-400 mr-2"></i>{{ t('admin_title') }}</h2>
                        <button @click="goHome"><i class="fas fa-times hover:text-gray-300"></i></button>
                    </div>
                    <div class="p-6">
                        <div class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <label class="block text-sm font-bold text-gray-700 mb-2">{{ t('label_add_item') }}</label>
                            <div class="flex flex-col gap-2">
                                <input v-model="adminNewItemName" :disabled="isSubmitting" type="text" :placeholder="t('ph_item_name')" class="w-full border border-gray-300 rounded-lg px-4 py-2 outline-none focus:border-green-500">
                                <div class="flex gap-2">
                                    <input v-model="adminNewItemOrg" :disabled="isSubmitting" type="text" :placeholder="t('ph_organizer')" class="flex-grow border border-gray-300 rounded-lg px-4 py-2 outline-none focus:border-green-500">
                                    
                                    <!-- 新增日期选择 -->
                                    <input v-model="adminNewItemStartDate" :disabled="isSubmitting" type="date" class="border border-gray-300 rounded-lg px-2 py-2 outline-none focus:border-green-500 text-sm text-gray-600">
                                    <span class="self-center text-gray-400">-</span>
                                    <input v-model="adminNewItemEndDate" :disabled="isSubmitting" type="date" class="border border-gray-300 rounded-lg px-2 py-2 outline-none focus:border-green-500 text-sm text-gray-600">
                                    
                                    <button @click="adminAddItem" :disabled="isSubmitting" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50 whitespace-nowrap"><i v-if="isSubmitting" class="fas fa-spinner fa-spin"></i> {{ t('btn_add') }}</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-700 mb-3">{{ t('label_cloud_list') }} ({{ competitionItems.length }})</h3>
                            <ul class="space-y-2 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                <li v-for="(item, index) in competitionItems" :key="index" class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-lg shadow-sm hover:shadow-md transition">
                                    <div class="flex items-center">
                                        <!-- 状态切换按钮 -->
                                        <button @click="toggleStatus(item)" class="mr-3 text-lg transition-transform active:scale-90 focus:outline-none" :title="item.status === 'closed' ? t('btn_start_comp') : t('btn_end_comp')">
                                            <i class="fas" :class="item.status === 'closed' ? 'fa-play-circle text-green-500' : 'fa-pause-circle text-gray-400'"></i>
                                        </button>

                                        <i :class="getCategoryIcon(item.name)" class="text-orange-400 mr-3 w-6 text-center"></i>
                                        <div class="flex flex-col">
                                            <span class="font-bold text-gray-800" :class="{'line-through text-gray-400': item.status === 'closed'}">{{ item.name }}</span>
                                            <div class="flex gap-2 text-xs text-gray-400">
                                                 <span v-if="item.organizer">{{ t('label_organizer') }}: {{ item.organizer }}</span>
                                                 <span v-if="item.startDate"> | {{ formatDate(item.startDate) }} <span v-if="item.endDate">- {{ formatDate(item.endDate) }}</span></span>
                                                 <span v-if="getCategoryStatus(item.name) === 'closed' && item.status === 'open'" class="text-red-500 font-bold">({{ t('status_auto_ended') }})</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="openEditCategory(item)" :disabled="isSubmitting" class="text-gray-400 hover:text-blue-500 p-2"><i class="fas fa-edit"></i></button>
                                        <button @click="adminDeleteItem(item.name)" :disabled="isSubmitting" class="text-gray-400 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </transition>

        </main>

        <!-- 海报预览 Modal -->
        <transition name="modal">
            <div v-if="posterModal.visible" class="fixed inset-0 z-[130] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 no-print">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-full">
                    <div class="bg-gray-800 text-white px-6 py-3 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-lg"><i class="fas fa-image mr-2"></i>{{ t('poster_title') }}</h3>
                        <button @click="posterModal.visible = false"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div class="overflow-y-auto p-4 flex-grow bg-gray-100 flex justify-center">
                        <div id="poster-container" class="poster-container w-[900px] min-h-[700px] p-8 relative shadow-2xl rounded-sm flex flex-col">
                            <div class="absolute top-0 left-0 w-32 h-32 border-t-8 border-l-8 border-yellow-400 rounded-tl-3xl m-6 opacity-60"></div>
                            <div class="absolute bottom-0 right-0 w-32 h-32 border-b-8 border-r-8 border-yellow-400 rounded-br-3xl m-6 opacity-60"></div>
                            
                            <div class="text-center mb-8 relative z-10">
                                <div class="text-yellow-200 text-xl mb-1 tracking-[0.2em] font-bold">{{ t('school_name') }}</div>
                                <h1 class="text-5xl font-bold text-white mb-3 text-shadow-lg tracking-wider">{{ selectedCategory }}</h1>
                                <div class="inline-block bg-gradient-to-r from-yellow-600 to-yellow-400 text-white border-2 border-yellow-200 px-8 py-1 rounded-full font-bold text-2xl shadow-xl mt-2">
                                    {{ t('poster_subtitle') }}
                                </div>
                            </div>

                            <div class="flex-grow relative z-10 flex gap-10 items-start">
                                <!-- Left -->
                                <div class="flex-1 space-y-6">
                                    <div v-for="(group, idx) in posterData.left" :key="'L'+idx">
                                        <div class="flex items-center mb-3">
                                            <div class="h-[2px] bg-yellow-400/50 flex-grow"></div>
                                            <span class="mx-4 text-yellow-200 font-bold text-xl">{{ group.translatedLabel }}</span>
                                            <div class="h-[2px] bg-yellow-400/50 flex-grow"></div>
                                        </div>
                                        <div class="grid grid-cols-1 gap-2">
                                            <div v-for="stu in group.winners" :key="stu.rowIndex" class="poster-card p-3 rounded flex items-center justify-between">
                                                <div>
                                                    <div class="text-red-800 font-bold text-lg leading-tight">{{ stu.studentName }}</div>
                                                    <div class="text-gray-500 text-xs mt-0.5">{{ stu.className }}</div>
                                                </div>
                                                <div class="text-right">
                                                    <span class="inline-block bg-red-50 text-red-700 border border-red-200 px-3 py-1 rounded-full text-xs font-bold">{{ t_rank(stu.rank) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="w-[2px] bg-yellow-400/30 self-stretch rounded-full"></div>
                                
                                <!-- Right -->
                                <div class="flex-1 space-y-6">
                                    <div v-for="(group, idx) in posterData.right" :key="'R'+idx">
                                        <div class="flex items-center mb-3">
                                            <div class="h-[2px] bg-yellow-400/50 flex-grow"></div>
                                            <span class="mx-4 text-yellow-200 font-bold text-xl">{{ group.translatedLabel }}</span>
                                            <div class="h-[2px] bg-yellow-400/50 flex-grow"></div>
                                        </div>
                                        <div class="grid grid-cols-1 gap-2">
                                            <div v-for="stu in group.winners" :key="stu.rowIndex" class="poster-card p-3 rounded flex items-center justify-between">
                                                <div>
                                                    <div class="text-red-800 font-bold text-lg leading-tight">{{ stu.studentName }}</div>
                                                    <div class="text-gray-500 text-xs mt-0.5">{{ stu.className }}</div>
                                                </div>
                                                <div class="text-right">
                                                    <span class="inline-block bg-red-50 text-red-700 border border-red-200 px-3 py-1 rounded-full text-xs font-bold">{{ t_rank(stu.rank) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="!posterData.left.length && !posterData.right.length" class="absolute inset-0 flex items-center justify-center text-white/50 text-xl font-bold">
                                {{ t('msg_no_winners') }}
                            </div>

                            <div class="text-center mt-10 text-yellow-200/60 text-xs">
                                {{ t('school_name') }} · {{ new Date().toLocaleDateString() }}
                            </div>
                        </div>
                    </div>

                    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3 shrink-0">
                        <button @click="posterModal.visible = false" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg font-bold">{{ t('btn_close') }}</button>
                        <button @click="downloadPoster" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-lg font-bold flex items-center">
                            <i class="fas fa-download mr-2"></i> {{ t('btn_save_img') }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 通用 Modal -->
        <transition name="modal">
            <div v-if="modalState.visible" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm no-print" @click.self="handleModalCancel">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden">
                    <div class="bg-orange-500 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="font-bold text-lg"><i :class="modalState.icon"></i> {{ modalState.title }}</h3>
                        <button @click="handleModalCancel"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4 whitespace-pre-line">{{ modalState.message }}</p>
                        <input v-if="['prompt', 'password'].includes(modalState.type)" :type="modalState.type === 'password' ? 'password' : 'text'" v-model="modalState.inputValue" @keyup.enter="handleModalConfirm" ref="modalInput" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 outline-none focus:border-orange-500" :placeholder="modalState.placeholder">
                    </div>
                    <div v-if="modalState.showButtons !== false" class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                        <button v-if="modalState.type !== 'alert'" @click="handleModalCancel" class="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded-lg text-sm font-bold">{{ t('btn_cancel') }}</button>
                        <button @click="handleModalConfirm" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-sm font-bold">{{ modalState.confirmText || t('btn_confirm') }}</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 编辑比赛项目专用 Modal -->
        <transition name="modal">
            <div v-if="editCategoryModal.visible" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/50 backdrop-blur-sm no-print">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden transform transition-all">
                    <div class="bg-blue-600 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="font-bold text-lg"><i class="fas fa-edit mr-2"></i>{{ t('modal_edit_title') }}</h3>
                        <button @click="editCategoryModal.visible = false"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">{{ t('ph_item_name') }} <span class="text-red-500">*</span></label>
                            <input type="text" v-model="editCategoryModal.newName" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">{{ t('label_organizer') }}</label>
                            <input type="text" v-model="editCategoryModal.organizer" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="如：教务处">
                        </div>
                        <div class="flex gap-2">
                            <div class="flex-1"><label class="block text-sm font-bold text-gray-700 mb-1">{{ t('label_start_date') }}</label><input type="date" v-model="editCategoryModal.startDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"></div>
                            <div class="flex-1"><label class="block text-sm font-bold text-gray-700 mb-1">{{ t('label_end_date') }}</label><input type="date" v-model="editCategoryModal.endDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"></div>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded text-xs text-yellow-800"><i class="fas fa-info-circle mr-1"></i> {{ t('hint_edit_sync') }}</div>
                    </div>
                    <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                        <button @click="editCategoryModal.visible = false" class="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded-lg text-sm font-bold">{{ t('btn_cancel') }}</button>
                        <button @click="submitEditCategory" :disabled="isSubmitting" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold disabled:opacity-50 flex items-center"><i v-if="isSubmitting" class="fas fa-spinner fa-spin mr-2"></i> {{ t('btn_save') }}</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 成绩录入专用 Modal -->
        <transition name="modal">
            <div v-if="scoreModal.visible" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/50 backdrop-blur-sm no-print">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden transform transition-all">
                    <div class="bg-blue-600 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="font-bold text-lg"><i class="fas fa-medal mr-2"></i>{{ t('modal_score_title') }}</h3>
                        <button @click="scoreModal.visible = false"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="bg-blue-50 p-3 rounded text-sm text-blue-800">
                            <strong>{{ scoreModal.className }}</strong> - <strong>{{ scoreModal.studentName }}</strong>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">{{ t('th_score') }}</label>
                            <input type="text" v-model="scoreModal.score" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如: 95">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">{{ t('th_rank') }}</label>
                            <select v-model="scoreModal.rank" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="">-</option>
                                <option v-for="r in rankOptions" :key="r" :value="r">{{ t_rank(r) }}</option>
                            </select>
                        </div>

                        <!-- 🔒 密码验证 -->
                        <div>
                            <label class="block text-sm font-bold text-red-600 mb-1">{{ t('label_password') }}</label>
                            <input type="password" v-model="scoreModal.password" class="w-full border-2 border-red-100 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-red-500 bg-red-50" :placeholder="t('ph_password')">
                        </div>
                    </div>
                    <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                        <button @click="scoreModal.visible = false" class="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded-lg text-sm font-bold">{{ t('btn_cancel') }}</button>
                        <button @click="submitScore" :disabled="isSubmitting" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold disabled:opacity-50 flex items-center">
                            <i v-if="isSubmitting" class="fas fa-spinner fa-spin mr-2"></i> {{ t('btn_confirm') }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;

        // ⚠️ 重要：替换为你最新的 Web App URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxp7Xcjc2IaJ75-y_hmu4JcaZLiP0XDf0ai227ii3hr_B8RRQEX5QRnwV5iJdqlpiXs/exec"; 

        const translations = {
            zh: {
                school_name: "新廊华小校内竞赛系统",
                school_header_print: "新廊华小",
                system_subtitle: "云端实时版",
                nav_lobby: "大厅",
                loading_connect: "正在连接云端数据库...",
                lobby_title: "比赛大厅",
                status_connecting: "连接中...",
                status_live: "实时同步",
                status_offline: "离线模式",
                search_placeholder: "搜姓名、班级或项目...",
                admin_mode_hint: "您处于管理员模式，点击名单旁的铅笔图标可录入成绩。",
                btn_exit_admin: "退出管理",
                label_ongoing: "进行中",
                label_registered: "已报",
                unit_person: "人",
                msg_no_competitions: "暂无比赛项目",
                btn_goto_add: "前往后台添加",
                btn_back: "返回",
                label_organizer: "主办",
                mode_entry: "录入模式",
                msg_no_records: "暂无报名记录",
                btn_go_register: "去报名",
                btn_batch_entry: "批量录入",
                btn_poster: "生成海报",
                btn_print_options: "打印选项",
                print_roster: "参赛点名表",
                print_score_sheet: "评分记录表",
                print_winners: "得奖名单",
                btn_add_reg: "新增报名",
                status_saving: "正在保存...",
                hint_batch_mode: "已进入批量录入模式，修改后请点击保存。",
                btn_cancel: "取消",
                btn_save_all: "保存全部",
                btn_save: "保存",
                total: "共",
                th_no: "序",
                th_class: "班级",
                th_name: "姓名",
                th_score: "分数",
                th_rank: "名次",
                th_note: "备注",
                reg_title: "报名录入",
                reg_subtitle: "所有选项均来自 Google Sheets 实时数据",
                label_item: "参赛项目",
                ph_select_item: "请点击选择参赛项目...",
                label_class: "所属班级",
                ph_select_class: "选择班级",
                chk_keep_class: "连续报名保留班级",
                label_students: "选择学生",
                hint_select_class_first: "请先选择班级",
                opt_empty: "(空)",
                btn_clear: "清空",
                btn_submitting: "提交中...",
                btn_confirm: "确认",
                btn_submit_reg: "确认报名",
                admin_title: "管理员模式",
                label_add_item: "添加新项目 (同步至云端)",
                ph_item_name: "比赛名称",
                ph_organizer: "主办单位 (选填)",
                btn_add: "添加",
                label_cloud_list: "云端项目列表",
                poster_title: "荣誉榜海报预览",
                poster_subtitle: "荣耀时刻 · 荣誉榜",
                msg_no_winners: "暂无得奖记录",
                btn_close: "关闭",
                btn_save_img: "保存为图片",
                modal_edit_title: "修改比赛项目",
                hint_edit_sync: "提示：修改比赛名称会同步更新已有报名记录中的项目名称。",
                modal_score_title: "成绩录入",
                label_password: "操作密码",
                ph_password: "请输入密码",
                status_ended: "已结束",
                status_auto_ended: "已截止 (日期)",
                btn_end_comp: "结束比赛",
                btn_start_comp: "恢复比赛",
                toast_success: "操作成功",
                toast_fail: "操作失败",
                label_signature: "签名",
                label_date: "日期",
                btn_add_student: "添加学生",
                btn_add_class: "增加班级",
                btn_remove_class: "移除班级",
                btn_login: "登入",
                label_start_date: "开始日期",
                label_end_date: "结束日期",
                grade_1: "一年级", grade_2: "二年级", grade_3: "三年级", grade_4: "四年级", grade_5: "五年级", grade_6: "六年级",
                rank_champ: "冠军", rank_runnerup: "亚军", rank_3rd: "季军", rank_4th: "第四名", rank_5th: "第五名",
                rank_distinction: "特优奖", rank_excellence: "优秀奖", rank_consolation: "安慰奖"
            },
            ms: {
                school_name: "Sistem Pertandingan SJK(C) Ladang Grisek",
                school_header_print: "SJK(C) Ladang Grisek",
                system_subtitle: "Versi Awan Masa Nyata",
                nav_lobby: "Lobi",
                loading_connect: "Menyambung ke Awan...",
                lobby_title: "Lobi Pertandingan",
                status_connecting: "Menyambung...",
                status_live: "Segerak",
                status_offline: "Luar Talian",
                search_placeholder: "Cari nama, kelas atau acara...",
                admin_mode_hint: "Mod Admin aktif. Klik ikon pensel untuk masukkan markah.",
                btn_exit_admin: "Keluar Admin",
                label_ongoing: "Sedang Berjalan",
                label_registered: "Daftar",
                unit_person: "orang",
                msg_no_competitions: "Tiada acara pertandingan",
                btn_goto_add: "Pergi Tambah",
                btn_back: "Kembali",
                label_organizer: "Penganjur",
                mode_entry: "Mod Input",
                msg_no_records: "Tiada rekod pendaftaran",
                btn_go_register: "Daftar Sekarang",
                btn_batch_entry: "Input Berkelompok",
                btn_poster: "Jana Poster",
                btn_print_options: "Pilihan Cetak",
                print_roster: "Senarai Kosong",
                print_score_sheet: "Borang Markah",
                print_winners: "Senarai Pemenang",
                btn_add_reg: "Tambah Daftar",
                status_saving: "Sedang Simpan...",
                hint_batch_mode: "Mod input berkelompok aktif. Sila simpan selepas ubah.",
                btn_cancel: "Batal",
                btn_save_all: "Simpan Semua",
                btn_save: "Simpan",
                total: "Jum",
                th_no: "No.",
                th_class: "Kelas",
                th_name: "Nama",
                th_score: "Markah",
                th_rank: "Kedudukan",
                th_note: "Catatan",
                reg_title: "Input Pendaftaran",
                reg_subtitle: "Pilihan dari Google Sheets masa nyata",
                label_item: "Acara Pertandingan",
                ph_select_item: "Sila pilih acara...",
                label_class: "Kelas",
                ph_select_class: "Pilih Kelas",
                chk_keep_class: "Kekalkan kelas dipilih",
                label_students: "Pilih Murid",
                hint_select_class_first: "Sila pilih kelas dahulu",
                opt_empty: "(Kosong)",
                btn_clear: "Kosongkan",
                btn_submitting: "Menghantar...",
                btn_confirm: "Sahkan",
                btn_submit_reg: "Sahkan Pendaftaran",
                admin_title: "Mod Pentadbir",
                label_add_item: "Tambah Acara Baru (Segerak Awan)",
                ph_item_name: "Nama Pertandingan",
                ph_organizer: "Penganjur (Pilihan)",
                btn_add: "Tambah",
                label_cloud_list: "Senarai Acara Awan",
                poster_title: "Pratonton Papan Kehormatan",
                poster_subtitle: "Saat Kegemilangan · Papan Kehormatan",
                msg_no_winners: "Tiada rekod pemenang",
                btn_close: "Tutup",
                btn_save_img: "Simpan Imej",
                modal_edit_title: "Ubah Acara",
                hint_edit_sync: "Petua: Mengubah nama akan mengemas kini rekod sedia ada.",
                modal_score_title: "Input Markah",
                label_password: "Kata Laluan Operasi",
                ph_password: "Masukkan kata laluan",
                status_ended: "Tamat",
                status_auto_ended: "Tamat (Tarikh)",
                btn_end_comp: "Tamatkan Acara",
                btn_start_comp: "Sambung Semula",
                toast_success: "Berjaya",
                toast_fail: "Gagal",
                label_signature: "Tandatangan",
                label_date: "Tarikh",
                btn_add_student: "Tambah Murid",
                btn_add_class: "Tambah Kelas",
                btn_remove_class: "Hapus Kelas",
                btn_login: "Log Masuk",
                label_start_date: "Tarikh Mula",
                label_end_date: "Tarikh Tamat",
                grade_1: "Tahun 1", grade_2: "Tahun 2", grade_3: "Tahun 3", grade_4: "Tahun 4", grade_5: "Tahun 5", grade_6: "Tahun 6",
                rank_champ: "Johan", rank_runnerup: "Naib Johan", rank_3rd: "Ketiga", rank_4th: "Keempat", rank_5th: "Kelima",
                rank_distinction: "Cemerlang", rank_excellence: "Kepujian", rank_consolation: "Saguhati"
            },
            en: {
                school_name: "SJK(C) Ladang Grisek Competition System",
                school_header_print: "SJK(C) Ladang Grisek",
                system_subtitle: "Cloud Real-time Version",
                nav_lobby: "Lobby",
                loading_connect: "Connecting to Cloud...",
                lobby_title: "Competition Lobby",
                status_connecting: "Connecting...",
                status_live: "Live Sync",
                status_offline: "Offline Mode",
                search_placeholder: "Search name, class or item...",
                admin_mode_hint: "Admin mode active. Click pencil icon to enter scores.",
                btn_exit_admin: "Exit Admin",
                label_ongoing: "Ongoing",
                label_registered: "Registered",
                unit_person: "pax",
                msg_no_competitions: "No competitions found",
                btn_goto_add: "Go Add",
                btn_back: "Back",
                label_organizer: "Organizer",
                mode_entry: "Entry Mode",
                msg_no_records: "No registration records",
                btn_go_register: "Register Now",
                btn_batch_entry: "Batch Entry",
                btn_poster: "Generate Poster",
                btn_print_options: "Print Options",
                print_roster: "Blank Roster",
                print_score_sheet: "Scoring Sheet",
                print_winners: "Winners List",
                btn_add_reg: "Add Registration",
                status_saving: "Saving...",
                hint_batch_mode: "Batch entry mode active. Please save changes.",
                btn_cancel: "Cancel",
                btn_save_all: "Save All",
                btn_save: "Save",
                total: "Total",
                th_no: "No.",
                th_class: "Class",
                th_name: "Name",
                th_score: "Score",
                th_rank: "Rank",
                th_note: "Note",
                reg_title: "Registration Entry",
                reg_subtitle: "Options from real-time Google Sheets",
                label_item: "Competition Item",
                ph_select_item: "Please select item...",
                label_class: "Class",
                ph_select_class: "Select Class",
                chk_keep_class: "Keep class selected",
                label_students: "Select Students",
                hint_select_class_first: "Please select class first",
                opt_empty: "(Empty)",
                btn_clear: "Clear",
                btn_submitting: "Submitting...",
                btn_confirm: "Confirm",
                btn_submit_reg: "Confirm Registration",
                admin_title: "Admin Mode",
                label_add_item: "Add New Item (Cloud Sync)",
                ph_item_name: "Competition Name",
                ph_organizer: "Organizer (Optional)",
                btn_add: "Add",
                label_cloud_list: "Cloud Item List",
                poster_title: "Honor Roll Preview",
                poster_subtitle: "Glory Moment · Honor Roll",
                msg_no_winners: "No winners record",
                btn_close: "Close",
                btn_save_img: "Save Image",
                modal_edit_title: "Edit Item",
                hint_edit_sync: "Tip: Renaming will sync update existing records.",
                modal_score_title: "Score Entry",
                label_password: "Operation Password",
                ph_password: "Enter password",
                status_ended: "Ended",
                status_auto_ended: "Ended (Date)",
                btn_end_comp: "End Competition",
                btn_start_comp: "Resume Competition",
                toast_success: "Success",
                toast_fail: "Failed",
                label_signature: "Signature",
                label_date: "Date",
                btn_add_student: "Add Student",
                btn_add_class: "Add Class",
                btn_remove_class: "Remove Class",
                btn_login: "Login",
                label_start_date: "Start Date",
                label_end_date: "End Date",
                grade_1: "Year 1", grade_2: "Year 2", grade_3: "Year 3", grade_4: "Year 4", grade_5: "Year 5", grade_6: "Year 6",
                rank_champ: "Champion", rank_runnerup: "Runner-up", rank_3rd: "3rd Place", rank_4th: "4th Place", rank_5th: "5th Place",
                rank_distinction: "Distinction", rank_excellence: "Excellence", rank_consolation: "Consolation"
            }
        };

        const rankOptions = ['冠军', '亚军', '季军', '第四名', '第五名', '特优奖', '优秀奖', '安慰奖'];

        createApp({
            setup() {
                const lang = ref(localStorage.getItem('app_lang') || 'zh');
                const t = (key) => translations[lang.value][key] || key;
                const setLang = (l) => { lang.value = l; localStorage.setItem('app_lang', l); };
                const currentLangLabel = computed(() => ({'zh':'中文', 'ms':'BM', 'en':'EN'}[lang.value]));

                const t_rank = (dbValue) => {
                    if (!dbValue) return '';
                    const map = {
                        '冠军': 'rank_champ', '亚军': 'rank_runnerup', '季军': 'rank_3rd',
                        '第四名': 'rank_4th', '第五名': 'rank_5th',
                        '特优奖': 'rank_distinction', '优秀奖': 'rank_excellence', '安慰奖': 'rank_consolation'
                    };
                    return map[dbValue] ? t(map[dbValue]) : dbValue;
                };

                const currentTab = ref('results');
                const selectedCategory = ref(null);
                const isInitializing = ref(true);
                const isRefreshing = ref(false);
                const isSubmitting = ref(false);
                const isAdmin = ref(false); 
                const isBatchEditing = ref(false); 
                const isOfflineMode = ref(false);
                
                const initStatus = ref({ items: false, students: false, results: false });
                
                const competitionItems = ref([]);
                const studentDB = ref({});
                const classList = ref([]);
                const dbResults = ref([]);
                const batchEditData = ref([]); 
                
                const form = ref({ 
                    category: '', 
                    groups: [{ id: Date.now(), class: '', students: [''] }] 
                });
                
                const keepClassInfo = ref(true);
                const adminNewItemName = ref('');
                const adminNewItemOrg = ref('');
                const adminNewItemStartDate = ref('');
                const adminNewItemEndDate = ref('');
                const searchQuery = ref('');

                const getStudentsByClass = (className) => {
                    return studentDB.value[className] || [];
                };

                const addClassGroup = () => {
                    form.value.groups.push({ id: Date.now(), class: '', students: [''] });
                };

                const removeClassGroup = (index) => {
                    form.value.groups.splice(index, 1);
                };

                const addStudentRow = (groupIndex) => {
                    form.value.groups[groupIndex].students.push('');
                };

                const removeStudentRow = (groupIndex, studentIndex) => {
                    form.value.groups[groupIndex].students.splice(studentIndex, 1);
                };

                const modalState = ref({ visible: false, type: 'alert', title: '', message: '', inputValue: '', placeholder: '', icon: '', resolve: null, confirmText: null, showButtons: true, autoClose: null });
                const modalInput = ref(null);
                const toastState = ref({ visible: false, message: '', type: 'success' });
                
                const scoreModal = ref({ visible: false, studentName: '', className: '', score: '', rank: '', category: '', password: '' });
                const editCategoryModal = ref({ visible: false, oldName: '', newName: '', organizer: '', startDate: '', endDate: '' });
                const posterModal = ref({ visible: false });
                const posterData = ref({ left: [], right: [] }); 

                let autoRefreshTimer = null;
                let toastTimer = null;
                let modalAutoCloseTimer = null;

                const initPWA = () => {
                    const manifest = {
                        name: "新廊华小校内竞赛系统",
                        short_name: "竞赛系统",
                        start_url: window.location.href.split('?')[0],
                        display: "standalone",
                        background_color: "#fffbeb",
                        theme_color: "#f97316",
                        icons: [{ src: "https://api.iconify.design/fxemoji/trophy.png", sizes: "512x512", type: "image/png" }]
                    };
                    const link = document.createElement('link');
                    link.rel = 'manifest';
                    link.href = `data:application/manifest+json;charset=utf-8,${encodeURIComponent(JSON.stringify(manifest))}`;
                    document.head.appendChild(link);
                };

                const showToast = (message, type = 'success') => {
                    toastState.value = { visible: true, message, type };
                    if (toastTimer) clearTimeout(toastTimer);
                    toastTimer = setTimeout(() => { toastState.value.visible = false; }, 2500);
                };

                const mockAPI = (action, payload) => {
                    return new Promise(resolve => {
                        setTimeout(() => {
                            if (action === 'getCompetitions') resolve(competitionItems.value || []);
                            else if (action === 'getStudents') resolve([]); 
                            else if (action === 'getResults') resolve(dbResults.value || []);
                            else resolve({ status: 'success', message: '离线模式: 模拟操作成功' });
                        }, 300);
                    });
                };

                const fetchAPI = async (action, payload = null) => {
                    if (GOOGLE_SCRIPT_URL.includes("在此处粘贴")) {
                        isOfflineMode.value = true;
                        throw new Error("API URL 未配置，系统已启用【本地离线预览模式】。");
                    }
                    if (isOfflineMode.value) {
                        return mockAPI(action, payload);
                    }
                    try {
                        if (payload) { 
                            const response = await fetch(GOOGLE_SCRIPT_URL, {
                                method: 'POST',
                                mode: 'no-cors', 
                                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                                body: JSON.stringify({ action, ...payload })
                            });
                            return response; 
                        } else { 
                            const timestamp = new Date().getTime();
                            const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=${action}&_t=${timestamp}`, {
                                method: 'GET',
                                redirect: 'follow'
                            });
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return await response.json();
                        }
                    } catch (error) {
                        console.error("API Error:", error);
                        isOfflineMode.value = true;
                        throw new Error("云端连接失败。\n请检查 Google Apps Script 部署权限是否设置为【所有人】。\n系统已自动为您切换至【本地离线模式】。");
                    }
                };

                const normalizeData = (rawData) => {
                    if (!Array.isArray(rawData)) return [];
                    return rawData.map(item => {
                        const newItem = {};
                        Object.keys(item).forEach(key => {
                            const k = key.toLowerCase().replace(/\s+/g, '');
                            if (['studentname', 'name', '姓名'].some(x => k.includes(x))) newItem.studentName = item[key];
                            else if (['studentclass', 'class', '班级'].some(x => k.includes(x))) newItem.studentClass = item[key];
                            else if (['category', 'competition'].some(x => k.includes(x))) newItem.category = item[key];
                            else if (['score', '分数'].some(x => k.includes(x))) newItem.score = item[key];
                            else if (['rank', '排名', '名次'].some(x => k.includes(x))) newItem.rank = item[key];
                            else newItem[key] = item[key];
                        });
                        if(!newItem.studentName) newItem.studentName = newItem.Name || '';
                        if(!newItem.studentClass) newItem.studentClass = newItem.Class || '';
                        if(!newItem.category) newItem.category = newItem.Category || '';
                        return newItem;
                    });
                };

                const fetchAllData = async (isBackground = false) => {
                    if (isBatchEditing.value && isBackground) return;
                    if (!isBackground) isRefreshing.value = true;
                    try {
                        const items = await fetchAPI('getCompetitions');
                        const normalizedItems = Array.isArray(items) 
                            ? items.map(i => typeof i === 'string' ? {name: i, organizer: '', status: 'open', startDate: '', endDate: ''} : i)
                            : [];
                        if(!isOfflineMode.value) competitionItems.value = normalizedItems;
                        initStatus.value.items = true;

                        const rawStudents = await fetchAPI('getStudents');
                        const cleanedStudents = normalizeData(rawStudents);
                        const db = {};
                        cleanedStudents.forEach(s => {
                            if(s.studentClass && s.studentName) {
                                if (!db[s.studentClass]) db[s.studentClass] = [];
                                db[s.studentClass].push(s.studentName);
                            }
                        });
                        if(!isOfflineMode.value) studentDB.value = db;
                        classList.value = Object.keys(studentDB.value).sort();
                        initStatus.value.students = true;

                        const rawResults = await fetchAPI('getResults');
                        const cleanedResults = normalizeData(rawResults);
                        if(!isOfflineMode.value) dbResults.value = cleanedResults.map((item, i) => ({ ...item, rowIndex: i }));
                        initStatus.value.results = true;
                        
                    } catch (e) {
                        console.error(e);
                        if (!isBackground) {
                           // 发生错误时，如果已经切换到离线模式，从本地存储加载，避免白屏
                           competitionItems.value = initItemsFromStorage();
                           initStatus.value.items = true;
                           initStatus.value.students = true;
                           initStatus.value.results = true;
                           await showDialog({ type: 'alert', title: '网络提示', message: e.message });
                        }
                    } finally {
                        isInitializing.value = false;
                        if (!isBackground) isRefreshing.value = false;
                    }
                };

                const initItemsFromStorage = () => {
                    const stored = localStorage.getItem('school_competition_items');
                    if (stored) {
                        try {
                            const parsed = JSON.parse(stored);
                            if (!Array.isArray(parsed)) return [];
                            const uniqueMap = new Map();
                            parsed.forEach(item => {
                                if (typeof item === 'string') {
                                    if (!uniqueMap.has(item)) uniqueMap.set(item, { name: item, organizer: '', status: 'open', startDate: '', endDate: '' });
                                } else if (item && item.name) {
                                    if (!uniqueMap.has(item.name)) uniqueMap.set(item.name, item);
                                }
                            });
                            return Array.from(uniqueMap.values());
                        } catch(e) { return []; }
                    }
                    return [];
                };

                onMounted(() => {
                    initPWA(); 
                    competitionItems.value = initItemsFromStorage();
                    fetchAllData();
                    autoRefreshTimer = setInterval(() => { fetchAllData(true); }, 60000);
                });
                
                watch(competitionItems, (newVal) => { localStorage.setItem('school_competition_items', JSON.stringify(newVal)); }, { deep: true });
                onUnmounted(() => { if (autoRefreshTimer) clearInterval(autoRefreshTimer); });

                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString; 
                    return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '/');
                };

                const adminAddItem = async () => {
                    const name = adminNewItemName.value.trim();
                    const organizer = adminNewItemOrg.value.trim();
                    const startDate = adminNewItemStartDate.value;
                    const endDate = adminNewItemEndDate.value;

                    if (!name) return showDialog({ title: 'Info', message: 'Name empty' });
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('addCompetition', { name, organizer, startDate, endDate });
                        if(isOfflineMode.value) {
                            competitionItems.value.push({name, organizer, startDate, endDate, status:'open'});
                        }
                        adminNewItemName.value = '';
                        adminNewItemOrg.value = '';
                        adminNewItemStartDate.value = '';
                        adminNewItemEndDate.value = '';
                        await fetchAllData(); 
                        showToast(t('toast_success'));
                    } catch(e) { console.error(e); }
                    isSubmitting.value = false;
                };

                const adminDeleteItem = async (name) => {
                    if (!(await showDialog({ type: 'confirm', title: 'Confirm', message: `Delete ${name}?`, icon: 'fas fa-trash' }))) return;
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('deleteCompetition', { name });
                        if(isOfflineMode.value) {
                            competitionItems.value = competitionItems.value.filter(i => i.name !== name);
                        }
                        await fetchAllData();
                        showToast(t('toast_success'));
                    } catch(e) { console.error(e); }
                    isSubmitting.value = false;
                };

                const toggleStatus = async (item) => {
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('toggleStatus', { name: item.name });
                        item.status = (item.status === 'closed') ? 'open' : 'closed';
                        showToast(t('toast_success'));
                    } catch(e) { console.error(e); }
                    finally { isSubmitting.value = false; }
                };

                const openEditCategory = (item) => {
                    editCategoryModal.value = { 
                        visible: true, 
                        oldName: item.name, 
                        newName: item.name, 
                        organizer: item.organizer || '',
                        startDate: item.startDate || '', 
                        endDate: item.endDate || ''     
                    };
                };

                const submitEditCategory = async () => {
                    const { oldName, newName, organizer, startDate, endDate } = editCategoryModal.value;
                    if (!newName.trim()) return showDialog({ title: 'Info', message: 'Name empty' });
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('editCompetition', { 
                            oldName, 
                            newName: newName.trim(), 
                            organizer: organizer.trim(),
                            startDate,
                            endDate
                        });
                        
                        if(isOfflineMode.value) {
                            const target = competitionItems.value.find(i => i.name === oldName);
                            if(target) {
                                target.name = newName.trim();
                                target.organizer = organizer.trim();
                                target.startDate = startDate;
                                target.endDate = endDate;
                            }
                        }

                        editCategoryModal.value.visible = false;
                        if (selectedCategory.value === oldName) selectedCategory.value = newName.trim();
                        await fetchAllData();
                        showToast(t('toast_success'));
                    } catch(e) { console.error(e); } finally { isSubmitting.value = false; }
                };

                const getCategoryStatus = (name) => {
                    const item = competitionItems.value.find(i => i.name === name);
                    if (!item) return 'closed';
                    if (item.status === 'closed') return 'closed';
                    if (item.endDate) {
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        const end = new Date(item.endDate);
                        if (today > end) return 'closed'; 
                    }
                    return 'open';
                };

                // Helper to get date range string
                const getSelectedGroupDateRange = () => {
                    const item = competitionItems.value.find(i => i.name === selectedCategory.value);
                    if (!item || !item.startDate) return '';
                    let range = formatDate(item.startDate);
                    if (item.endDate) {
                        range += ` - ${formatDate(item.endDate)}`;
                    }
                    return range;
                };

                const activeCompetitions = computed(() => competitionItems.value.filter(i => {
                    if (i.status === 'closed') return false;
                    if (i.endDate) {
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        const end = new Date(i.endDate);
                        if (today > end) return false;
                    }
                    return true;
                }));

                const submitForm = async () => {
                    let allEntries = [];
                    form.value.groups.forEach(group => {
                        if (!group.class) return;
                        group.students.forEach(stuName => {
                            if (stuName && stuName.trim()) {
                                allEntries.push({
                                    studentName: stuName,
                                    studentClass: group.class,
                                    category: form.value.category
                                });
                            }
                        });
                    });

                    const uniqueEntries = [];
                    const seen = new Set();
                    allEntries.forEach(entry => {
                        const key = `${entry.studentClass}-${entry.studentName}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            uniqueEntries.push(entry);
                        }
                    });

                    if (uniqueEntries.length === 0) return showDialog({ title: 'Info', message: 'No valid students selected' });

                    const currentCatStudents = dbResults.value.filter(s => s.category === form.value.category);
                    const duplicates = [];
                    const finalEntries = uniqueEntries.filter(entry => {
                        const isDup = currentCatStudents.some(s => s.studentName === entry.studentName && s.studentClass === entry.studentClass);
                        if (isDup) duplicates.push(`${entry.studentName}(${entry.studentClass})`);
                        return !isDup;
                    });

                    if (duplicates.length > 0) {
                         await showDialog({ type: 'alert', title: 'Duplicate', message: `Already reg: ${duplicates.join(', ')}` });
                    }
                    if (finalEntries.length === 0) return;

                    isSubmitting.value = true;
                    let successCount = 0;
                    for (const entry of finalEntries) {
                        try {
                            await fetchAPI('register', { name: entry.studentName, stuClass: entry.studentClass, category: entry.category });
                            if(isOfflineMode.value) dbResults.value.push(entry);
                            successCount++;
                        } catch(e) { console.error(e); }
                    }
                    showToast(`${t('toast_success')} ${successCount}`);
                    
                    if (keepClassInfo.value) {
                         form.value.groups.forEach(g => g.students = ['']);
                    } else {
                        form.value.category = '';
                        form.value.groups = [{ id: Date.now(), class: '', students: [''] }];
                    }
                    isSubmitting.value = false;
                    fetchAllData(); 
                };

                const deleteRegistration = async (stu, className) => {
                    if (!await showDialog({ type: 'confirm', title: 'Confirm', message: `Delete ${stu.studentName}?` })) return;
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('deleteRegistration', { name: stu.studentName, stuClass: className, category: selectedCategory.value });
                        if(isOfflineMode.value) {
                             dbResults.value = dbResults.value.filter(s => !(s.studentName === stu.studentName && s.studentClass === className && s.category === selectedCategory.value));
                        }
                        showToast(t('toast_success'));
                        fetchAllData();
                    } catch (e) { console.error(e); } finally { isSubmitting.value = false; }
                };

                const startBatchEdit = async () => {
                    const pwd = await showDialog({ type: 'password', title: t('admin_title'), message: t('ph_password'), placeholder: '***', icon: 'fas fa-lock', confirmText: t('btn_login') });
                    if (pwd !== '888888') { if (pwd !== false) await showDialog({ title: 'Error', message: 'Wrong password' }); return; }
                    
                    await showDialog({ title: t('toast_success'), message: '管理员模式已开启', showButtons: false, autoClose: 1500, icon: 'fas fa-check-circle' });
                    
                    batchEditData.value = JSON.parse(JSON.stringify(getSelectedGroupedByGrade()));
                    isBatchEditing.value = true;
                };

                const cancelBatchEdit = () => { isBatchEditing.value = false; batchEditData.value = []; };

                const saveBatchEdit = async () => {
                    isSubmitting.value = true;
                    let changeCount = 0;
                    const updates = [];
                    batchEditData.value.forEach(group => {
                        group.classes.forEach(cls => {
                            cls.students.forEach(stu => {
                                const original = dbResults.value.find(orig => orig.studentName === stu.studentName && orig.studentClass === cls.className && orig.category === selectedCategory.value);
                                if (original) {
                                    const newScore = String(stu.score || '').trim(), newRank = String(stu.rank || '').trim();
                                    const oldScore = String(original.score || '').trim(), oldRank = String(original.rank || '').trim();
                                    if (newScore !== oldScore || newRank !== oldRank) updates.push({ name: stu.studentName, stuClass: cls.className, category: selectedCategory.value, score: newScore, rank: newRank });
                                }
                            });
                        });
                    });

                    if (updates.length === 0) { isSubmitting.value = false; isBatchEditing.value = false; return; }

                    try {
                        for (let i = 0; i < updates.length; i++) { 
                            await fetchAPI('updateScore', updates[i]); 
                            if(isOfflineMode.value) {
                                const target = dbResults.value.find(s => s.studentName === updates[i].name && s.studentClass === updates[i].stuClass && s.category === updates[i].category);
                                if(target){ target.score = updates[i].score; target.rank = updates[i].rank; }
                            }
                            changeCount++; 
                        }
                        showToast(`${t('toast_success')} ${changeCount}`);
                        isBatchEditing.value = false;
                        fetchAllData(); 
                    } catch (e) { console.error(e); } finally { isSubmitting.value = false; }
                };

                const openScoreModal = (stu, className) => { scoreModal.value = { visible: true, studentName: stu.studentName, className: className, score: stu.score || '', rank: stu.rank || '', category: selectedCategory.value, password: '' }; };

                const submitScore = async () => {
                    if (scoreModal.value.password !== '888888') { await showDialog({ type: 'alert', title: 'Error', message: 'Wrong password' }); return; }
                    isSubmitting.value = true;
                    try {
                        await fetchAPI('updateScore', { name: scoreModal.value.studentName, stuClass: scoreModal.value.className, category: scoreModal.value.category, score: scoreModal.value.score, rank: scoreModal.value.rank });
                        scoreModal.value.visible = false;
                        const target = dbResults.value.find(s => s.studentName === scoreModal.value.studentName && s.studentClass === scoreModal.value.className && s.category === scoreModal.value.category);
                        if (target) { target.score = scoreModal.value.score; target.rank = scoreModal.value.rank; }
                        showToast(t('toast_success'));
                    } catch(e) { console.error(e); } finally { isSubmitting.value = false; }
                };

                const generatePrintHtml = (title, tableContent) => {
                    const categoryName = selectedCategory.value;
                    const date = new Date().toLocaleDateString('en-GB'); 
                    const groupInfo = groupedResults.value.find(g => g.categoryName === categoryName);
                    const orgText = groupInfo && groupInfo.organizer ? `<div style="margin-bottom:5px;">${t('label_organizer')}: ${groupInfo.organizer}</div>` : '';
                    const schoolHeader = `${t('school_header_print')} ${new Date().getFullYear()}${lang.value === 'zh' ? '年' : ''}`;

                    return `<html><head><title>${categoryName} - ${title}</title>
                            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css" />
                            <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai&display=swap" rel="stylesheet">
                            <style>
                                * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
                                body { font-family: "LXGW WenKai Screen", "LXGW WenKai", KaiTi, "楷体", STKaiti, "华文楷体", serif; padding: 20px; width: 100%; margin: 0; }
                                .header-top { text-align: center; font-size: 18px; margin-bottom: 2px; }
                                h1 { text-align: center; margin-bottom: 5px; font-size: 24px; font-weight: bold; }
                                .subtitle { text-align: center; font-size: 14px; margin-bottom: 10px; color: #555; }
                                table { width: 99.5%; margin: 0 auto; border-collapse: collapse; font-size: 13px; break-inside: auto; }
                                th, td { border: 1px solid #000; padding: 2px 2px; text-align: center; line-height: 1.2; }
                                th { background-color: #f0f0f0; font-weight: bold; padding: 4px 2px; }
                                tr { break-inside: avoid; break-after: auto; }
                                .grade-header { background-color: #e0e0e0; font-weight: bold; text-align: left; padding-left: 10px; font-size: 14px; padding-top: 3px; padding-bottom: 3px; }
                                .signature { margin-top: 30px; display: flex; justify-content: space-between; padding: 0 40px; font-size: 14px; page-break-inside: avoid; }
                                .generated-date { position: fixed; bottom: 10px; left: 10px; font-size: 12px; color: #555; }
                                
                                /* Screen-only controls for PWA */
                                .screen-controls {
                                    position: fixed; top: 0; left: 0; right: 0;
                                    background: rgba(255, 255, 255, 0.95);
                                    padding: 10px;
                                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                    display: flex; justify-content: space-between; align-items: center;
                                    z-index: 9999;
                                }
                                .btn { padding: 6px 16px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; }
                                .btn-close { background: #f3f4f6; color: #333; }
                                .btn-print { background: #f97316; color: white; }
                                .spacer { height: 60px; }

                                @page { size: A4; margin: 10mm; }
                                @media print { 
                                    body { width: 100%; } 
                                    .generated-date { position: fixed; bottom: 0; } 
                                    .screen-controls, .spacer { display: none; }
                                }
                            </style>
                        </head><body>
                            <div class="screen-controls">
                                <button class="btn btn-close" onclick="window.close()">✖ ${t('btn_close')}</button>
                                <button class="btn btn-print" onclick="window.print()">🖨️ ${t('btn_print_options')}</button>
                            </div>
                            <div class="spacer"></div>
                            
                            <div class="header-top">${schoolHeader}</div>
                            <h1>${categoryName} - ${title}</h1><div class="subtitle">${orgText}</div>
                            ${tableContent}
                            ${!title.includes(t('print_winners')) ? `<div class="signature"><div>${t('label_signature')}: ________________</div><div>${t('label_date')}: ________________</div></div>` : ''}
                            <div class="generated-date">Generated: ${date}</div>
                            <script>window.onload = () => { setTimeout(() => window.print(), 500); };${'</'}script></body></html>`;
                };

                const printRoster = () => {
                    let tableContent = `<table><thead><tr><th style="width:5%">${t('th_no')}</th><th style="width:60%">${t('th_name')}</th><th style="width:10%">${t('th_class')}</th><th style="width:25%">${t('th_note')}</th></tr></thead><tbody>`;
                    getSelectedGroupedByGrade().forEach(group => {
                        const unit = lang.value === 'zh' ? '人' : (lang.value === 'ms' ? ' orang' : ' pax');
                        tableContent += `<tr><td colspan="4" class="grade-header">${group.translatedLabel} (${t('total')} ${group.totalStudents}${unit})</td></tr>`;
                        let index = 1;
                        group.classes.forEach(cls => { cls.students.forEach(stu => { tableContent += `<tr><td>${index++}</td><td style="text-align:left;padding-left:10px">${stu.studentName}</td><td>${cls.className}</td><td></td></tr>`; }); });
                    });
                    tableContent += `</tbody></table>`;
                    const win = window.open('', '_blank'); win.document.write(generatePrintHtml(t('print_roster'), tableContent)); win.document.close();
                };

                const printScoringSheet = () => {
                    let tableContent = `<table><thead><tr><th style="width:5%">${t('th_no')}</th><th style="width:45%">${t('th_name')}</th><th style="width:10%">${t('th_class')}</th><th style="width:15%">${t('th_score')}</th><th style="width:15%">${t('th_rank')}</th><th style="width:10%">${t('th_note')}</th></tr></thead><tbody>`;
                    getSelectedGroupedByGrade().forEach(group => {
                        const unit = lang.value === 'zh' ? '人' : (lang.value === 'ms' ? ' orang' : ' pax');
                        tableContent += `<tr><td colspan="6" class="grade-header">${group.translatedLabel} (${t('total')} ${group.totalStudents}${unit})</td></tr>`;
                        let index = 1;
                        group.classes.forEach(cls => { cls.students.forEach(stu => { tableContent += `<tr><td>${index++}</td><td style="text-align:left;padding-left:10px">${stu.studentName}</td><td>${cls.className}</td><td>${stu.score||''}</td><td>${t_rank(stu.rank)||''}</td><td></td></tr>`; }); });
                    });
                    tableContent += `</tbody></table>`;
                    const win = window.open('', '_blank'); win.document.write(generatePrintHtml(t('print_score_sheet'), tableContent)); win.document.close();
                };

                const printResults = () => {
                    let tableContent = `<table><thead><tr><th style="width:15%">${t('th_rank')}</th><th style="width:65%">${t('th_name')}</th><th style="width:20%">${t('th_class')}</th></tr></thead><tbody>`;
                    let hasWinners = false;
                    getSelectedGroupedByGrade().forEach(group => {
                        const winners = [];
                        group.classes.forEach(cls => { cls.students.forEach(stu => { if(stu.rank) winners.push({...stu, className: cls.className}); }); });
                        if(winners.length > 0) {
                            hasWinners = true;
                            tableContent += `<tr><td colspan="3" class="grade-header">${group.translatedLabel}</td></tr>`;
                            winners.sort((a,b) => (getRankWeight(b.rank) - getRankWeight(a.rank)) || ((parseFloat(b.score)||0) - (parseFloat(a.score)||0)));
                            winners.forEach(stu => { tableContent += `<tr><td style="font-weight:normal;">${t_rank(stu.rank)}</td><td style="font-weight:normal;">${stu.studentName}</td><td style="font-size:14px;">${stu.className}</td></tr>`; });
                        }
                    });
                    if(!hasWinners) tableContent += `<tr><td colspan="3" style="color:#999; padding:20px;">${t('msg_no_winners')}</td></tr>`;
                    tableContent += `</tbody></table>`;
                    const win = window.open('', '_blank'); win.document.write(generatePrintHtml(t('print_winners'), tableContent)); win.document.close();
                };

                // --- 🎨 海报生成 (双栏强行分割) ---
                const openPosterModal = () => {
                    const gradeGroups = getSelectedGroupedByGrade();
                    const left = [], right = [];
                    gradeGroups.forEach(g => {
                        const winners = [];
                        g.classes.forEach(c => {
                            c.students.forEach(s => { if (s.rank) winners.push({ ...s, className: c.className }); });
                        });
                        if (winners.length > 0) {
                            winners.sort((a,b) => (getRankWeight(b.rank) - getRankWeight(a.rank)) || ((parseFloat(b.score)||0) - (parseFloat(a.score)||0)));
                            if (['1','2','3'].some(k => g.gradeLabel.includes(k))) left.push({ translatedLabel: g.translatedLabel, winners });
                            else right.push({ translatedLabel: g.translatedLabel, winners });
                        }
                    });
                    posterData.value = { left, right };
                    posterModal.value.visible = true;
                };

                const downloadPoster = () => {
                    const el = document.getElementById('poster-container');
                    if (!el) return;
                    html2canvas(el, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `${selectedCategory.value || '比赛'}_荣誉榜.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    }).catch(e => {
                        console.error(e);
                        showToast('生成海报失败', 'error');
                    });
                };

                const exportCSV = () => {
                    const groupData = getSelectedGroupedByGrade();
                    let csvContent = "\uFEFF"; 
                    csvContent += `"${selectedCategory.value}"\n"${t('th_class')}","${t('th_name')}","${t('th_score')}","${t('th_rank')}"\n`;
                    groupData.forEach(group => { group.classes.forEach(cls => { cls.students.forEach(stu => { csvContent += `"${cls.className}","${stu.studentName}","${stu.score || ''}","${t_rank(stu.rank) || ''}"\n`; }); }); });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
                    link.download = `${selectedCategory.value}_成绩名单.csv`;
                    document.body.appendChild(link); link.click(); document.body.removeChild(link);
                    showToast('Excel Exported');
                };

                // Helper Functions
                const showDialog = (opts) => new Promise(resolve => { 
                    if (modalAutoCloseTimer) clearTimeout(modalAutoCloseTimer);
                    modalState.value = { 
                        visible: true, 
                        type: opts.type || 'alert', 
                        title: opts.title || 'Info', 
                        message: opts.message || '', 
                        placeholder: opts.placeholder || '', 
                        icon: opts.icon || 'fas fa-info-circle', 
                        resolve, 
                        confirmText: opts.confirmText || null,
                        showButtons: opts.showButtons !== false // Default true
                    }; 
                    
                    if (opts.autoClose) {
                        modalAutoCloseTimer = setTimeout(() => {
                            if (modalState.value.visible) {
                                modalState.value.resolve(true); // Resolve as success
                                modalState.value.visible = false;
                            }
                        }, opts.autoClose);
                    }

                    if(['prompt','password'].includes(opts.type)) nextTick(() => { if(modalInput.value) modalInput.value.focus() }); 
                });
                const handleModalConfirm = () => { 
                    if (modalAutoCloseTimer) clearTimeout(modalAutoCloseTimer);
                    modalState.value.resolve(modalState.value.type === 'confirm' ? true : modalState.value.inputValue); 
                    modalState.value.visible = false; 
                };
                const handleModalCancel = () => { 
                    if (modalAutoCloseTimer) clearTimeout(modalAutoCloseTimer);
                    modalState.value.resolve(false); 
                    modalState.value.visible = false; 
                };
                
                const enterAdmin = async () => {
                    if (isAdmin.value) { 
                        // Already admin, go to backend directly
                        currentTab.value = 'admin'; 
                        selectedCategory.value = null; 
                        return; 
                    }
                    const pwd = await showDialog({ type: 'password', title: t('admin_title'), message: t('ph_password'), placeholder: '***', icon: 'fas fa-lock', confirmText: t('btn_login') });
                    if (pwd === "123456") { 
                        isAdmin.value = true; 
                        await showDialog({ title: t('toast_success'), message: '管理员模式已开启', showButtons: false, autoClose: 1500, icon: 'fas fa-check-circle' });
                    }
                    else if (pwd !== false) showDialog({ title: 'Error', message: t('toast_fail') });
                };

                const getRankWeight = (rank) => {
                    if (!rank) return 0;
                    if (rank.includes('冠') || rank === 'Champion' || rank === 'Johan') return 10000;
                    if (rank.includes('亚') || rank === 'Runner-up' || rank === 'Naib Johan') return 9000;
                    if (rank.includes('季') || rank === '3rd Place' || rank === 'Ketiga') return 8000;
                    if (rank.includes('四') || rank === '4th Place' || rank === 'Keempat') return 7000;
                    if (rank.includes('五') || rank === '5th Place' || rank === 'Kelima') return 6000;
                    if (rank.includes('特优') || rank === 'Distinction' || rank === 'Cemerlang') return 5000;
                    if (rank.includes('优秀') || rank === 'Excellence' || rank === 'Kepujian') return 4000;
                    if (rank.includes('安慰') || rank === 'Consolation' || rank === 'Saguhati') return 3000;
                    return 1000;
                };

                const groupedResults = computed(() => {
                    let filtered = dbResults.value;
                    if (searchQuery.value) filtered = filtered.filter(i => JSON.stringify(i).toLowerCase().includes(searchQuery.value.toLowerCase()));
                    return competitionItems.value.map(catObj => {
                        const catName = typeof catObj === 'string' ? catObj : (catObj?.name || '');
                        if (!catName) return null;
                        const students = filtered.filter(d => d.category && d.category.trim() === catName.trim());
                        if (searchQuery.value && students.length === 0) return null;
                        
                        students.sort((a, b) => (getRankWeight(b.rank) - getRankWeight(a.rank)) || ((parseFloat(b.score)||0) - (parseFloat(a.score)||0)));
                        const classMap = {};
                        students.forEach(s => { const c = s.studentClass || '未分类'; if (!classMap[c]) classMap[c] = []; classMap[c].push(s); });
                        
                        let effectiveStatus = catObj.status || 'open';
                        if (effectiveStatus !== 'closed' && catObj.endDate) {
                            const today = new Date();
                            today.setHours(0,0,0,0);
                            const end = new Date(catObj.endDate);
                            if (today > end) effectiveStatus = 'auto_closed';
                        }
                        
                        return { 
                            categoryName: catName, 
                            organizer: typeof catObj === 'object' ? (catObj.organizer || '') : '', 
                            status: catObj.status || 'open', 
                            startDate: catObj.startDate || '', 
                            endDate: catObj.endDate || '', 
                            effectiveStatus: effectiveStatus,
                            totalCount: students.length, 
                            classes: Object.keys(classMap).sort().map(c => ({ className: c, students: classMap[c] })) 
                        };
                    }).filter(i => i !== null);
                });

                // 分离进行中和已结束的比赛
                const visibleOngoingGroups = computed(() => {
                    return groupedResults.value.filter(g => g.effectiveStatus === 'open');
                });

                const visibleEndedGroups = computed(() => {
                    return groupedResults.value.filter(g => g.effectiveStatus !== 'open');
                });

                const getSelectedGroupCount = () => groupedResults.value.find(g => g.categoryName === selectedCategory.value)?.totalCount || 0;
                const getSelectedGroupOrganizer = () => groupedResults.value.find(g => g.categoryName === selectedCategory.value)?.organizer || '';
                
                const getSelectedGroupedByGrade = () => {
                    const group = groupedResults.value.find(g => g.categoryName === selectedCategory.value);
                    if (!group) return [];
                    const gradesMap = {};
                    group.classes.forEach(cls => {
                        const gradeChar = cls.className.charAt(0);
                        if (!gradesMap[gradeChar]) gradesMap[gradeChar] = [];
                        gradesMap[gradeChar].push(cls);
                    });
                    const gradeNamesZh = {'1':'一年级', '2':'二年级', '3':'三年级', '4':'四年级', '5':'五年级', '6':'六年级'};
                    return Object.keys(gradesMap).sort().map(g => {
                        const classesInGrade = gradesMap[g];
                        const totalStudents = classesInGrade.reduce((sum, cls) => sum + cls.students.length, 0);
                        const labelKey = `grade_${g}`;
                        const translatedLabel = translations[lang.value][labelKey] || (gradeNamesZh[g] || g);
                        return { gradeLabel: g, translatedLabel, totalStudents, classes: classesInGrade };
                    });
                };

                const exitCategory = () => {
                    if (isBatchEditing.value && !confirm("Exit batch mode? Unsaved changes will be lost.")) return;
                    isBatchEditing.value = false; selectedCategory.value = null;
                };

                const getCategoryIcon = (n) => {
                    if (!n) return 'fas fa-trophy';
                    const name = n.toLowerCase();
                    // 剪纸 (zh), Gunting (ms), Cutting (en)
                    if(name.includes('剪') || name.includes('gunting') || name.includes('cutting')) return 'fas fa-cut';
                    // 挥春/毛笔 (zh), Kaligrafi (ms), Calligraphy (en)
                    if(name.includes('挥春') || name.includes('书法') || name.includes('kaligrafi') || name.includes('calligraphy')) return 'fas fa-paint-brush';
                    // 故事/阅读 (zh), Cerita/Membaca (ms), Story/Reading (en)
                    if(name.includes('故事') || name.includes('语') || name.includes('cerita') || name.includes('story') || name.includes('reading')) return 'fas fa-book-open';
                    // 朗读/演讲 (zh), Syarahan/Pidato (ms), Public Speaking/Poetry (en)
                    if(name.includes('朗读') || name.includes('演讲') || name.includes('syarahan') || name.includes('pidato') || name.includes('speaking')) return 'fas fa-bullhorn';
                    // 笔试/作文 (zh), Karangan/Penulisan (ms), Writing/Essay (en)
                    if(name.includes('书') || name.includes('笔') || name.includes('作文') || name.includes('karangan') || name.includes('penulisan') || name.includes('writing') || name.includes('essay')) return 'fas fa-pen-nib';
                    // 画画/填色 (zh), Melukis/Mewarna (ms), Drawing/Coloring/Poster (en)
                    if(name.includes('画') || name.includes('美') || name.includes('melukis') || name.includes('mewarna') || name.includes('drawing') || name.includes('coloring') || name.includes('poster')) return 'fas fa-palette';
                    // 数学/心算 (zh), Matematik/Kira (ms), Math/Calculation (en)
                    if(name.includes('算') || name.includes('数') || name.includes('matematik') || name.includes('math')) return 'fas fa-calculator';
                    // 唱歌/音乐 (zh), Nyanyian/Muzik (ms), Singing/Music (en)
                    if(name.includes('歌') || name.includes('唱') || name.includes('舞') || name.includes('nyanyian') || name.includes('muzik') || name.includes('singing') || name.includes('music')) return 'fas fa-microphone-alt';
                    // 运动/赛跑 (zh), Sukan/Larian (ms), Sports/Running/Athletics (en)
                    if(name.includes('跑') || name.includes('球') || name.includes('体') || name.includes('sukan') || name.includes('larian') || name.includes('sports') || name.includes('running')) return 'fas fa-running';
                    
                    return 'fas fa-trophy';
                };
                
                const getRankClass = (rank) => {
                    if (!rank) return '';
                    if (rank.includes('冠') || rank === 'Champion' || rank === 'Johan') return 'bg-yellow-100 text-yellow-700 border border-yellow-200';
                    if (rank.includes('亚') || rank === 'Runner-up' || rank === 'Naib Johan') return 'bg-gray-200 text-gray-700 border border-gray-300';
                    if (rank.includes('季') || rank === '3rd Place' || rank === 'Ketiga') return 'bg-orange-100 text-orange-700 border border-orange-200';
                    if (rank.includes('四') || rank === '4th Place' || rank === 'Keempat') return 'bg-teal-100 text-teal-700 border border-teal-200';
                    if (rank.includes('五') || rank === '5th Place' || rank === 'Kelima') return 'bg-indigo-100 text-indigo-700 border border-indigo-200';
                    if (rank.includes('特优') || rank === 'Distinction' || rank === 'Cemerlang') return 'bg-purple-100 text-purple-700 border border-purple-200';
                    return 'bg-blue-50 text-blue-600 border border-blue-100';
                };

                return {
                    currentTab, selectedCategory, isInitializing, isRefreshing, isSubmitting, initStatus, isAdmin, isBatchEditing, isOfflineMode,
                    competitionItems, availableClasses: computed(() => classList.value), availableStudents: computed(() => studentDB.value[form.value.stuClass] || []),
                    form, searchQuery, keepClassInfo, adminNewItemName, adminNewItemOrg, adminNewItemStartDate, adminNewItemEndDate, batchEditData,
                    goHome: () => { currentTab.value = 'results'; selectedCategory.value = null; isBatchEditing.value = false; },
                    goToRegister: (cat) => { currentTab.value = 'register'; form.value.category = cat; },
                    exitCategory,
                    groupedResults, visibleOngoingGroups, visibleEndedGroups, getSelectedGroupCount, getSelectedGroupOrganizer, getSelectedGroupedByGrade, getCategoryIcon, getRankClass, getSelectedGroupDateRange, formatDate,
                    modalState, handleModalConfirm, handleModalCancel, modalInput, toastState,
                    scoreModal, openScoreModal, submitScore, 
                    printRoster, printScoringSheet, printResults, exportCSV, downloadPoster,
                    deleteRegistration, startBatchEdit, cancelBatchEdit, saveBatchEdit,
                    editCategoryModal, openEditCategory, submitEditCategory, toggleStatus, getCategoryStatus, activeCompetitions,
                    enterAdmin, adminAddItem, adminDeleteItem, submitForm, fetchAllData,
                    posterModal, posterData,
                    t, setLang, currentLangLabel, rankOptions, t_rank,
                    addClassGroup, removeClassGroup, addStudentRow, removeStudentRow, getStudentsByClass 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
